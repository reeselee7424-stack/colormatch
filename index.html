<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æœæ±è½¯ç³–é…å¯¹ - å‡çº§ç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1330">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text:#e5e7eb;
      --panel:rgba(17,24,39,.62);
      --blue:rgba(59,130,246,.95);
      
      /* åŠ¨æ€å˜é‡ï¼šæ¯å­å¤§å°ï¼Œé»˜è®¤å€¼ */
      --cup-sz: 60px; 
      --candy-w: 86%; /* ç³–æœå®½åº¦å æ¯” */
      --candy-h: 68%; /* ç³–æœé«˜åº¦å æ¯” */
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans CJK SC",sans-serif;
      color:var(--text);
      overflow:hidden;
      /* é˜²æ­¢ç§»åŠ¨ç«¯å›å¼¹æ•ˆæœ */
      overscroll-behavior: none;

      background:
        radial-gradient(900px 520px at 35% 10%, rgba(255,255,255,.16), transparent 55%),
        radial-gradient(820px 520px at 75% 15%, rgba(255,255,255,.10), transparent 58%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg,#0b1330 0%,#0b2a3a 30%,#0a3a4a 55%,#0a2b43 100%);
    }

    /* ===== èƒŒæ™¯æ³¡æ³¡ ===== */
    .bg-bubbles{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
    .bubble{
      position:absolute; bottom:-60px; border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 55% 65%, rgba(255,255,255,.10), rgba(255,255,255,0) 62%);
      border:1px solid rgba(255,255,255,.18);
      opacity:.55;
      animation: rise var(--dur) linear infinite, sway var(--sway) ease-in-out infinite;
      left: var(--x);
      width: var(--size);
      height: var(--size);
      animation-delay: var(--delay);
    }
    @keyframes rise{ from{ transform: translateY(0); } to{ transform: translateY(-110vh); } }
    @keyframes sway{ 0%,100%{ margin-left:0; } 50%{ margin-left:var(--sx); } }

    /* ===== ä¸»ç•Œé¢ ===== */
    .wrap{ width:min(1040px, 96vw); position:relative; z-index:1; display: flex; flex-direction: column; height: 98vh; padding-top: 1vh;}
    header{
      display:flex; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      gap:8px; margin-bottom:10px; flex-shrink: 0;
    }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; text-shadow:0 10px 30px rgba(0,0,0,.35); white-space: nowrap;}
    
    .meta{
      display:flex; flex-wrap:wrap; gap:8px;
      color:rgba(226,232,240,.85); font-size:12px; align-items:center;
    }
    .btn{
      background:rgba(31,41,55,.72);
      color:var(--text);
      border:1px solid rgba(148,163,184,.28);
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      font-size: 12px;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn-danger { border-color: rgba(239, 68, 68, 0.5); color: #fca5a5; }

    .panel{
      background: var(--panel);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 20px 60px rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      touch-action: none;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .grid{ 
      display:flex; 
      flex-direction: column;
      gap:10px; 
      height: 100%;
    }

    .attemptArea{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px;
      background: rgba(0,0,0,.10);
      flex-grow: 1;
      overflow: hidden;
      position: relative;
    }

    .attempts{
      height: 100%;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-right:4px;
    }

    .rowCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:8px;
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
      flex-shrink: 0;
    }
    .rowCard.active{
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.1), 0 4px 12px rgba(0,0,0,.2);
    }

    .slots{
      display:grid;
      gap:6px;
      justify-content: center; /* å±…ä¸­æ˜¾ç¤º */
      /* å…³é”®ä¿®æ”¹ï¼šåŠ¨æ€åˆ—å®½ */
      grid-template-columns: repeat(var(--count), var(--cup-sz)); 
    }

    /* ===== ç»ç’ƒæ¯ (è‡ªé€‚åº”å¤§å°) ===== */
    .cup{
      width: var(--cup-sz); 
      height: calc(var(--cup-sz) * 0.95); /* é«˜åº¦ç•¥å°äºå®½åº¦ */
      border-radius:999px;
      position:relative; overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        inset 0 18px 26px rgba(0,0,0,.30),
        inset 0 -18px 30px rgba(255,255,255,.04),
        0 4px 10px rgba(0,0,0,.20);
      backdrop-filter: blur(2px);
    }
    .cup::before{
      content:"";
      position:absolute; inset:8%; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      opacity:.9; z-index:30; pointer-events:none;
    }
    .cup::after{
      content:"";
      position:absolute; left:12%; top:12%;
      width:28%; height:60%; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
      opacity:.9; z-index:30; pointer-events:none;
      filter: blur(.2px);
    }
    .cup.dropHover{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    /* é”™è¯¯æ®‹ç•™ï¼ˆç•™åœ¨æ¯é‡Œï¼‰ */
    .cup .residue{
      position:absolute; inset:12%; border-radius:999px;
      background:
        radial-gradient(40% 30% at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(60% 50% at 65% 60%, rgba(0,0,0,.25), transparent 70%),
        radial-gradient(circle at 50% 65%, var(--residue) 0 55%, transparent 75%);
      opacity:.72; filter: blur(1px); z-index:4; pointer-events:none;
    }

    /* ===== æ¤­åœ†è½¯ç³– (è‡ªé€‚åº”) ===== */
    .candy{
      width: var(--candy-w); 
      height: var(--candy-h); 
      border-radius:999px;
      position:relative; overflow:hidden;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 5px 8px rgba(255,255,255,.20), inset 0 -8px 10px rgba(0,0,0,.18), 0 5px 9px rgba(0,0,0,.26);
      backdrop-filter: blur(2px);
      transform: translateZ(0);
      user-select:none;
      z-index:10;
      /* å±…ä¸­æ”¾ç½® */
      margin: auto;
      top: 50%;
      transform: translateY(-50%);
    }
    .paletteCandy .candy { top: 0; transform: none; margin: 0;} /* è°ƒè‰²ç›˜é‡Œä¸éœ€è¦å±…ä¸­åç§» */

    .candy::before{
      content:""; position:absolute; left:14%; top:12%;
      width:54%; height:55%; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 65%);
      transform: rotate(-12deg); opacity:.95; pointer-events:none;
    }
    
    .paletteCandy{ cursor:grab; touch-action: none; display: flex; justify-content: center; align-items: center;}
    .paletteCandy:active{ cursor:grabbing; }
    .used{ opacity:.42; filter:saturate(.7); }
    .cupCandy{ position:absolute; left:0; right:0; cursor:default; }

    /* ===== ç³–æœæ±  ===== */
    .paletteCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:10px;
      background: rgba(0,0,0,.10);
      flex-shrink: 0;
    }
    .paletteRow{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:4px 2px 8px 2px;
      min-height: calc(var(--cup-sz) + 10px);
      align-items: center;
    }
    .paletteRow::-webkit-scrollbar{ height:6px; }
    .paletteRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.2); border-radius:999px; }

    .paletteItem{
      flex-shrink: 0;
      width: var(--cup-sz);
      height: calc(var(--cup-sz) * 0.95);
      display:flex; justify-content:center; align-items:center;
    }
    /* è°ƒè‰²ç›˜é‡Œçš„ç³–æœå¤§å°ç¨å¾®ç»Ÿä¸€ä¸€ç‚¹ï¼Œæˆ–è€…è·Ÿéšæ¯å­å¤§å° */
    .paletteItem .candy {
      width: 100%; height: 100%;
    }

    /* ===== åŠ¨ç”»ä¸ç‰¹æ•ˆ ===== */
    .pop{ animation: pop 260ms ease-out forwards; z-index:12; }
    @keyframes pop{
      0%{ transform: translate(0,-50%) scale(1); opacity:1; }
      60%{ transform: translate(0,-55%) scale(1.06); opacity:.9; }
      100%{ transform: translate(0,10%) scale(.18); opacity:0; }
    }

    .splat{
      position:absolute; inset:10%;
      border-radius: 46% 54% 55% 45% / 52% 46% 54% 48%;
      background: var(--splat); opacity:.92; filter: blur(.3px);
      z-index:6; transform: rotate(var(--rot));
    }
    .drip{
      position:absolute; width:15%; height:30%;
      border-radius:999px; background: var(--splat); opacity:.90;
      z-index:6; transform-origin: top; animation: drip 520ms ease-out forwards;
    }
    @keyframes drip{ from{ transform:scaleY(.2); opacity:0; } to{ transform:scaleY(1); opacity:.90; } }

    .particle{
      position:absolute; width:4px; height:4px; border-radius:50%;
      pointer-events:none; z-index:20; opacity:.95;
      animation: fly 430ms ease-out forwards; background: var(--p);
    }
    @keyframes fly{ to{ transform: translate(var(--dx), var(--dy)) scale(0); opacity:0; } }

    .attempts::-webkit-scrollbar{ width:6px; }
    .attempts::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.1); border-radius: 999px; }
    
    html, body { touch-action: manipulation; } 
    .candy { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <audio id="bg-soda" preload="auto" loop></audio>
  <audio id="sfx-pop" preload="auto"></audio>
  <audio id="sfx-correct" preload="auto"></audio>

  <div class="wrap">
    <header>
      <h1>ğŸ§ƒğŸ¬ æœæ±è½¯ç³–</h1>
      <div class="meta">
        <div>å…³å¡ï¼š<span id="level">1</span></div>
        <div>é…å¯¹ï¼š<span id="pairs">3</span></div>
        
        <button class="btn" id="soundBtn">ğŸ”‡</button>
        <button class="btn" id="resetLevel" title="é‡è¯•æœ¬å…³">â†º æœ¬å…³</button>
        <button class="btn btn-danger" id="fullReset" title="æ¸…é™¤æ‰€æœ‰è¿›åº¦">âš  æ¸…æ¡£é‡æ¥</button>
      </div>
    </header>

    <div class="panel">
      <div class="grid">
        <div class="attemptArea">
          <div class="attempts" id="attempts"></div>
        </div>

        <div class="paletteCard">
          <div class="paletteRow" id="palette"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ===== æ ¸å¿ƒé…ç½® ===== */
  // 1. æ‰©å……é¢œè‰²æ± åˆ° 14 ç§ï¼Œä»¥æ”¯æŒ Level 25+ çš„é«˜éš¾åº¦
  const COLOR_POOL = [
    {name:"çº¢", hex:"#ef4444"},
    {name:"æ©™", hex:"#f97316"},
    {name:"é»„", hex:"#fde047"},
    {name:"ç»¿", hex:"#16a34a"},
    {name:"é’", hex:"#22d3ee"},
    {name:"è“", hex:"#1d4ed8"},
    {name:"ç´«", hex:"#a855f7"},
    {name:"ç²‰", hex:"#fb7185"},
    {name:"æ£•", hex:"#5b341a"},
    // æ–°å¢é¢œè‰²
    {name:"ç°", hex:"#9ca3af"},
    {name:"é…¸æ©™", hex:"#84cc16"},
    {name:"é›é’", hex:"#4338ca"},
    {name:"ç«ç‘°", hex:"#e11d48"},
    {name:"å¢¨ç»¿", hex:"#14532d"}
  ];

  /* ===== çŠ¶æ€ç®¡ç† (å¸¦ LocalStorage) ===== */
  const STORAGE_KEY = 'gummy_match_save_v1';
  
  function loadProgress() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? parseInt(saved, 10) : 1;
  }

  function saveProgress(lvl) {
    localStorage.setItem(STORAGE_KEY, lvl);
  }

  function clearProgress() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  let level = loadProgress(); // åˆå§‹åŠ è½½è¿›åº¦
  let pairCount = 3;
  let ids = [];
  let correctSeq = [];
  let attempts = [];
  let activeRowIndex = 0;
  let soundOn = false;

  /* ===== DOM å…ƒç´  ===== */
  const elLevel = document.getElementById("level");
  const elPairs = document.getElementById("pairs");
  const elAttempts = document.getElementById("attempts");
  const elPalette = document.getElementById("palette");
  const btnResetLevel = document.getElementById("resetLevel");
  const btnFullReset = document.getElementById("fullReset");
  const rootStyle = document.documentElement.style;

  /* ===== å£°éŸ³ç³»ç»Ÿ ===== */
  const bgSoda = document.getElementById("bg-soda");
  const sfxPop = document.getElementById("sfx-pop");
  const sfxCorrect = document.getElementById("sfx-correct");
  
  bgSoda.src = "soda.mp3";
  sfxPop.src = "pop.mp3";
  sfxCorrect.src = "correct.mp3";
  
  const soundBtn = document.getElementById("soundBtn");
  
  soundBtn.addEventListener("click", () => {
    soundOn = !soundOn;
    soundBtn.textContent = soundOn ? "ğŸ”Š" : "ğŸ”‡";
    if(soundOn) {
        bgSoda.volume = 0.2;
        bgSoda.play().catch(()=>{});
    } else {
        bgSoda.pause();
    }
  });

  function playOne(audio){
    if(!soundOn) return;
    audio.currentTime=0; 
    audio.play().catch(()=>{});
  }

  /* ===== è‡ªé€‚åº”å¸ƒå±€æ ¸å¿ƒ ===== */
  // æ ¹æ®å±å¹•å®½åº¦å’Œè‰²å—æ•°é‡ï¼ŒåŠ¨æ€è°ƒæ•´æ¯å­å¤§å°
  function adjustLayoutSize() {
    const screenW = window.innerWidth;
    const padding = 32; // å·¦å³é¢„ç•™é—´éš™
    const gap = 6;      // æ ¼å­é—´éš™
    
    // è®¡ç®—å…¬å¼ï¼šå¯ç”¨å®½åº¦ / æ•°é‡ - é—´éš™
    // æœ€å¤§ 90pxï¼Œæœ€å° 28px (é˜²æ­¢å¤ªå°çœ‹ä¸æ¸…)
    let size = (screenW - padding - (gap * (pairCount - 1))) / pairCount;
    size = Math.min(90, Math.max(28, size));
    
    rootStyle.setProperty('--cup-sz', `${size}px`);
    
    // åŠ¨æ€è°ƒæ•´ç³–æœå†…è¾¹è·ï¼Œè¶Šå°è¶Šæ»¡
    if (size < 40) {
        rootStyle.setProperty('--candy-w', '92%');
        rootStyle.setProperty('--candy-h', '75%');
    } else {
        rootStyle.setProperty('--candy-w', '86%');
        rootStyle.setProperty('--candy-h', '68%');
    }
  }
  
  window.addEventListener('resize', adjustLayoutSize);

  /* ===== æ¸¸æˆé€»è¾‘ ===== */
  const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

  function pairsForLevel(lvl){
    // éš¾åº¦æ›²çº¿è°ƒæ•´
    if (lvl <= 25) {
        if (lvl === 1) return 3;
        const base = 4 + Math.floor((lvl - 2) / 3);
        return Math.min(base, 9); // 25å…³ä¹‹å‰æœ€å¤š9ä¸ª
    } else {
        // 25å…³ä¹‹åï¼š9 åˆ° 14 ä¸ªéšæœº
        return Math.floor(Math.random() * (14 - 9 + 1)) + 9;
    }
  }

  function setupLevel(){
    pairCount = pairsForLevel(level);
    adjustLayoutSize(); // æ¯æ¬¡å¼€å±€é‡æ–°è®¡ç®—å°ºå¯¸é€‚é…

    // ä»é¢œè‰²æ± ä¸­å–å‰ pairCount ä¸ªé¢œè‰²å¹¶æ‰“ä¹±ä½œä¸ºç­”æ¡ˆ
    const allIndices = COLOR_POOL.map((_,i)=>i);
    // å¦‚æœéœ€è¦çš„é¢œè‰²è¶…è¿‡æ± å­å¤§å°(è™½ç„¶ç°åœ¨å¤Ÿäº†)ï¼Œåšä¸ªä¿æŠ¤
    const poolSize = Math.min(pairCount, COLOR_POOL.length);
    
    ids = shuffle(allIndices).slice(0, poolSize);
    correctSeq = shuffle([...ids]);

    attempts = [{
      guess: Array(pairCount).fill(null),
      status: "active",
      residue: Array(pairCount).fill(null),
    }];
    activeRowIndex = 0;
    renderAll();
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
        elAttempts.scrollTop = elAttempts.scrollHeight;
    }, 50);
  }

  function placeColor(rowIdx, cupIdx, colorId){
    const row = attempts[rowIdx];
    if (!row || row.status !== "active") return;

    // å¦‚æœè¿™ä¸ªé¢œè‰²å·²ç»åœ¨åˆ«å¤„ç”¨äº†ï¼Œæ¸…é™¤åŸæ¥çš„
    const prevPos = row.guess.findIndex(v => v === colorId);
    if (prevPos !== -1 && prevPos !== cupIdx){
      row.guess[prevPos] = null;
    }
    row.guess[cupIdx] = colorId;

    renderAll();

    // æ£€æŸ¥æ˜¯å¦å¡«æ»¡
    if (row.guess.every(v => v !== null)){
      const marks = row.guess.map((id, i) => id === correctSeq[i]);
      const allRight = marks.every(Boolean);

      row.marks = marks;
      row.status = allRight ? "ok" : "bad";

      if (row.status === "bad"){
        // è®°å½•é”™è¯¯æ®‹ç•™é¢œè‰²
        row.stains = marks.map((ok, i) => ok ? "" : COLOR_POOL[row.guess[i]].hex);
        row.residue = row.residue.map((old, i) => marks[i] ? old : COLOR_POOL[row.guess[i]].hex);
        row.burstDone = false;
        row.wrongGone = marks.map(() => false);
      }

      renderAll();

      if (allRight){
        playOne(sfxCorrect);
        setTimeout(() => {
          level++;
          saveProgress(level); // ä¿å­˜è¿›åº¦ï¼
          setupLevel();
        }, 800);
      } else {
        playOne(sfxPop);
        setTimeout(() => {
          attempts.push({
            guess: Array(pairCount).fill(null),
            status: "active",
            residue: Array(pairCount).fill(null),
          });
          activeRowIndex = attempts.length - 1;
          renderAll();
          elAttempts.scrollTop = elAttempts.scrollHeight;
        }, 400);
      }
    }
  }

  /* ===== æ¸²æŸ“é€»è¾‘ ===== */
  function makeCandyDiv(colorId, { inCup = false } = {}) {
    const c = COLOR_POOL[colorId];
    const d = document.createElement("div");
    d.className = "candy";
    d.dataset.colorId = String(colorId);
    d.style.background = `linear-gradient(135deg, ${c.hex}, rgba(255,255,255,.10))`;

    if (inCup) {
      d.classList.add("cupCandy");
    } else {
      d.classList.add("paletteCandy");
      // æ‹–æ‹½é€»è¾‘
      d.draggable = true;
      d.addEventListener("dragstart", (e) => {
        draggingColorId = colorId;
        e.dataTransfer.setData("text/plain", String(colorId));
      });
      // è§¦æ‘¸é€»è¾‘åœ¨å…¨å±€å¤„ç†
      d.addEventListener("touchstart", (e) => {
         e.preventDefault();
         draggingColorId = colorId;
         const t = e.touches[0];
         draggingTouch = { id: t.identifier, x: t.clientX, y: t.clientY };
      }, {passive:false});
    }
    return d;
  }

  function renderPalette(){
    elPalette.innerHTML = "";
    const active = attempts[activeRowIndex];
    const usedSet = new Set((active?.guess ?? []).filter(v => v !== null));

    ids.forEach(colorId => {
      const item = document.createElement("div");
      item.className = "paletteItem";
      const candy = makeCandyDiv(colorId);
      if (usedSet.has(colorId)) candy.classList.add("used");
      item.appendChild(candy);
      elPalette.appendChild(item);
    });
  }

  function renderAttempts(){
    elAttempts.innerHTML = "";
    attempts.forEach((row, idx) => {
      const card = document.createElement("div");
      card.className = "rowCard" + (idx === activeRowIndex ? " active" : "");
      
      const slots = document.createElement("div");
      slots.className = "slots";
      // ä¼ é€’ CSS å˜é‡ç»™ slotsï¼Œè™½ç„¶æˆ‘ä»¬åœ¨ adjustLayoutSize å…¨å±€è®¾äº†ï¼Œä½†è¿™é‡Œä¸ºäº†è¯­ä¹‰
      slots.style.setProperty('--count', pairCount);

      for (let s=0; s<pairCount; s++){
        const cup = document.createElement("div");
        cup.className = "cup";
        cup.dataset.row = idx;
        cup.dataset.slot = s;

        // æ®‹ç•™
        if (row.residue[s]){
          const r = document.createElement("div");
          r.className = "residue";
          r.style.setProperty("--residue", row.residue[s]);
          cup.appendChild(r);
        }

        // äº¤äº’äº‹ä»¶
        if (row.status === "active"){
          cup.addEventListener("dragover", e => { e.preventDefault(); cup.classList.add("dropHover"); });
          cup.addEventListener("dragleave", () => cup.classList.remove("dropHover"));
          cup.addEventListener("drop", (e) => {
            e.preventDefault();
            cup.classList.remove("dropHover");
            const cid = e.dataTransfer.getData("text/plain");
            if(cid) placeColor(idx, s, Number(cid));
            else if(draggingColorId !== null) placeColor(idx, s, draggingColorId);
          });
        }

        // ç³–æœæ¸²æŸ“
        const val = row.guess[s];
        const isWrong = row.status === "bad" && row.marks && !row.marks[s];
        const gone = row.wrongGone && row.wrongGone[s];

        if (val !== null && !(isWrong && gone)){
            cup.appendChild(makeCandyDiv(val, {inCup:true}));
        }
        slots.appendChild(cup);
      }
      
      card.appendChild(slots);
      elAttempts.appendChild(card);

      // çˆ†ç‚¸ç‰¹æ•ˆé€»è¾‘
      if (row.status === "bad" && !row.burstDone){
        setTimeout(() => { // å»¶è¿Ÿä¸€ç‚¹è®© DOM æ¸²æŸ“å®Œ
            const cupEls = slots.querySelectorAll(".cup");
            row.marks.forEach((ok, i) => {
                if(!ok){
                    const hex = row.stains[i];
                    addSplat(cupEls[i], hex);
                    const candy = cupEls[i].querySelector(".cupCandy");
                    if(candy) {
                        candy.classList.add("pop");
                        setTimeout(() => {
                            row.wrongGone[i] = true;
                            renderAll();
                        }, 260);
                    } else {
                         row.wrongGone[i] = true;
                    }
                }
            });
            row.burstDone = true;
        }, 10);
      }
    });
  }

  function renderAll(){
    elLevel.textContent = level;
    elPairs.textContent = pairCount;
    renderPalette();
    renderAttempts();
  }

  /* ===== ç‰¹æ•ˆå·¥å…·å‡½æ•° ===== */
  function addSplat(parent, hex){
    const s = document.createElement("div");
    s.className = "splat";
    s.style.setProperty("--splat", hex);
    s.style.setProperty("--rot", (Math.random()*20-10)+"deg");
    parent.appendChild(s);
    
    // å¢åŠ æ»´è½æ•ˆæœ
    for(let k=0;k<2;k++){
       const d = document.createElement("div");
       d.className="drip";
       d.style.setProperty("--splat", hex);
       d.style.left = (20+Math.random()*60)+"%";
       d.style.top = (50+Math.random()*20)+"%";
       parent.appendChild(d);
    }
  }

  /* ===== å…¨å±€äº¤äº’å˜é‡ ===== */
  let draggingColorId = null;
  let draggingTouch = null;
  let touchHoverCup = null;

  document.addEventListener("touchmove", (e) => {
    if (!draggingColorId) return;
    const t = Array.from(e.touches).find(x => x.identifier === draggingTouch.id);
    if (!t) return;
    
    e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
    const el = document.elementFromPoint(t.clientX, t.clientY);
    const cup = el ? el.closest(".cup") : null;

    if (touchHoverCup && touchHoverCup !== cup) touchHoverCup.classList.remove("dropHover");
    if (cup) cup.classList.add("dropHover");
    touchHoverCup = cup;
  }, {passive:false});

  document.addEventListener("touchend", (e) => {
    if (!draggingColorId) return;
    if (touchHoverCup) {
        touchHoverCup.classList.remove("dropHover");
        const r = Number(touchHoverCup.dataset.row);
        const s = Number(touchHoverCup.dataset.slot);
        if(!isNaN(r)) placeColor(r, s, draggingColorId);
        touchHoverCup = null;
    }
    draggingColorId = null;
    draggingTouch = null;
  }, {passive:false});

  /* ===== èƒŒæ™¯æ³¡æ³¡ (ä¼˜åŒ–ç‰ˆ) ===== */
  const bg = document.getElementById("bgBubbles");
  for(let i=0;i<20;i++){
    const b = document.createElement("div");
    b.className = "bubble";
    const size = 10 + Math.random()*30;
    b.style.setProperty("--size", size+"px");
    b.style.setProperty("--x", Math.random()*100 + "vw");
    b.style.setProperty("--dur", (10+Math.random()*10)+"s");
    b.style.setProperty("--delay", (-Math.random()*20)+"s");
    b.style.setProperty("--sway", (3+Math.random()*3)+"s");
    b.style.setProperty("--sx", (Math.random()*20-10)+"px");
    bg.appendChild(b);
  }

  /* ===== æŒ‰é’®äº‹ä»¶ ===== */
  btnResetLevel.addEventListener("click", () => {
    // é‡ç½®æœ¬å…³ä¸æ”¹å˜ levelï¼Œä¸ä¿å­˜
    attempts = [{
      guess: Array(pairCount).fill(null),
      status: "active",
      residue: Array(pairCount).fill(null),
    }];
    activeRowIndex = 0;
    renderAll();
  });

  btnFullReset.addEventListener("click", () => {
    if(confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¿›åº¦ä»ç¬¬1å…³å¼€å§‹å—ï¼Ÿ")){
        clearProgress();
    }
  });

  // åˆå§‹åŒ–
  setupLevel();

  // æ³¨å†Œ Service Worker (ä¿æŒåŸæ ·)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(console.warn);
    });
  }

})();
</script>
</body>
</html>
