<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æœæ±è½¯ç³– - æœå†»ç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1e3a8a">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text: #fff;
      --blue-glow: rgba(59,130,246,0.6);
      
      /* å°ºå¯¸è°ƒæ•´ï¼šæ•´ä½“ç¼©å° */
      --cup-w: 42px; 
      --cup-h: 46px;
      --candy-sz: 34px;
    }

    body{
      margin:0; height:100vh; display:flex; justify-content:center;
      font-family: "PingFang SC", "Segoe UI", sans-serif;
      color:var(--text); overflow:hidden; overscroll-behavior: none;
      
      /* ===== å‚è€ƒå›¾èƒŒæ™¯ï¼šæ·±æµ·è“æ¸å˜ ===== */
      background: radial-gradient(circle at 50% 20%, #1e40af 0%, #172554 60%, #020617 100%);
    }

    /* æ°”æ³¡è£…é¥° */
    .bg-bubbles{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .bubble{
      position:absolute; border-radius:50%;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      animation: rise linear infinite;
      bottom:-60px; left: var(--x); width: var(--size); height: var(--size);
      animation-duration: var(--dur);
    }
    @keyframes rise{ to{ transform: translateY(-110vh); } }

    .app-container {
      width: 100%; max-width: 420px; height: 100%;
      position: relative; display: flex; flex-direction: column; z-index: 1;
    }

    /* é¡¶éƒ¨æ  */
    header{
      padding: 15px 20px; display:flex; justify-content:space-between; align-items:flex-start;
    }
    .info-area { text-align: center; flex: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .info-area h2 { margin:0; font-size: 18px; font-weight: 500; }
    .info-area p { margin:4px 0 0; font-size: 14px; opacity: 0.8; }
    
    .controls { display: flex; gap: 10px; }
    .icon-btn{
      background: rgba(255,255,255,0.2); 
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      border: 1px solid rgba(255,255,255,0.3);
      cursor: pointer; font-size: 16px;
      backdrop-filter: blur(4px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }

    /* æ¸¸æˆåŒº */
    .game-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 10px 0; }
    .attempts-scroll {
        flex: 1; overflow-y: auto; padding: 20px 0;
        display: flex; flex-direction: column; gap: 16px;
        align-items: center;
        scroll-behavior: smooth;
        mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
        -webkit-mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
    }
    
    .row-card{
      display: flex; justify-content: center; padding: 0 10px;
      flex-shrink: 0; transition: all 0.3s;
      opacity: 0.8; transform: scale(0.95);
    }
    /* å½“å‰è¡Œé«˜äº® */
    .row-card.active{
      opacity: 1; transform: scale(1);
    }

    .slots{ display:grid; gap: 8px; grid-template-columns: repeat(var(--count), var(--cup-w)); }

    /* ===== æ–°ç‰ˆæ¯å­ï¼šæ¢¯å½¢ç»ç’ƒæ¯ (Shot Glass) ===== */
    .cup{
      width: var(--cup-w); height: var(--cup-h);
      position:relative; 
      /* æ¢¯å½¢é€ å‹ */
      border-radius: 2px 2px 12px 12px;
      /* ç»ç’ƒè´¨æ„Ÿ */
      background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
      border: 1px solid rgba(255,255,255,0.3);
      border-top: 1px solid rgba(255,255,255,0.5); /* æ¯å£æ›´äº® */
      box-shadow: 
        inset 0 0 8px rgba(255,255,255,0.1),
        0 4px 8px rgba(0,0,0,0.3);
    }
    /* æ¯åº•åšåº¦æ„Ÿ */
    .cup::after {
      content:""; position:absolute; bottom:2px; left:4px; right:4px; height: 6px;
      background: rgba(255,255,255,0.1); border-radius: 0 0 8px 8px;
      filter: blur(1px);
    }
    /* æ‹–æ‹½é«˜äº® */
    .cup.dropHover{ 
      background: rgba(255,255,255,0.25); 
      box-shadow: 0 0 15px var(--blue-glow);
      border-color: #fff;
    }

    /* æ®‹ç•™å±‚ (åªåœ¨æ¯åº•) */
    .residue-layer {
      position: absolute; bottom: 4px; left: 4px; right: 4px; height: 20px;
      background: var(--c); opacity: 0.8;
      border-radius: 4px 4px 8px 8px;
      filter: blur(4px); pointer-events: none;
    }

    /* ===== æ–°ç‰ˆè½¯ç³–ï¼šæœå†»è´¨æ„Ÿ (Gumdrop) ===== */
    .candy{
      width: var(--candy-sz); height: calc(var(--candy-sz) * 0.85);
      position:absolute; left:50%; top:50%; 
      transform: translate(-50%, -40%); /* ç¨å¾®é ä¸‹ä¸€ç‚¹ */
      z-index: 10;
      
      /* æœå†»å½¢çŠ¶ï¼šä¸Šåœ†ä¸‹å¹³ */
      border-radius: 50% 50% 45% 45%;
      
      /* é«˜çº§æœå†»è´¨æ„Ÿ */
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9) 0%, transparent 40%),
                  radial-gradient(circle at 50% 100%, rgba(255,255,255,0.4) 0%, transparent 50%),
                  var(--bg);
      
      box-shadow: 
        inset 0 -2px 4px rgba(0,0,0,0.2), /* åº•éƒ¨é˜´å½± */
        0 2px 4px rgba(0,0,0,0.3);     /* æŠ•å½± */
      
      border: 1px solid rgba(255,255,255,0.15);
    }
    
    .candy.fade-out { opacity: 0; transform: translate(-50%, -20%) scale(0.5); transition: all 0.3s; }

    /* åº•éƒ¨è°ƒè‰²ç›˜ */
    .palette-area {
      background: rgba(15, 23, 42, 0.6); 
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 0;
      /* åº•éƒ¨åœ†è§’å¡ç‰‡æ„Ÿ */
      margin: 0 10px 20px 10px;
      border-radius: 20px;
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .palette-scroll { 
      display:flex; justify-content: center; gap:8px; 
      padding: 12px; flex-wrap: wrap; 
    }
    .p-item { 
      width: 44px; height: 44px; 
      display:flex; justify-content:center; align-items:center; 
    }
    
    .palette-candy { position: relative; left: auto; top: auto; transform: none; width: 100%; height: 100%; }
    
    /* æ‹–æ‹½æºé˜´å½± */
    .palette-candy.dragging-source {
      opacity: 0.3; background: #000 !important;
      border-radius: 50%; transform: scale(0.8);
      box-shadow: inset 0 0 10px #000;
    }
    .palette-candy.dragging-source::before { display:none; }

    .candy.used { filter: grayscale(0.8) opacity(0.4); }

    /* æ‹–æ‹½é¬¼å½± */
    .drag-ghost {
      position: fixed; pointer-events: none; z-index: 9999;
      opacity: 0.9; transform: translate(-50%, -50%) scale(1.2);
    }
  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <div class="app-container">
    <header>
        <div class="info-area">
          <h2>å…³å¡ <span id="level">1</span></h2>
          <p>é…å¯¹ <span id="pairs">3</span></p>
        </div>
        <div class="controls">
            <div class="icon-btn" id="soundBtn">ğŸ”‡</div>
            <div class="icon-btn" id="resetBtn">â†º</div>
        </div>
    </header>

    <div class="game-area">
        <div class="attempts-scroll" id="attempts"></div>
    </div>

    <div class="palette-area">
        <div class="palette-scroll" id="palette"></div>
    </div>
  </div>

  <audio id="bg-soda" loop src="soda.mp3" preload="auto"></audio>
  <audio id="sfx-pop" src="pop.mp3" preload="auto"></audio>
  <audio id="sfx-correct" src="correct.mp3" preload="auto"></audio>

<script>
(() => {
  /* ===== é¢œè‰²æ± ï¼šé«˜é¥±å’Œåº¦æœå†»è‰² ===== */
  const COLORS = [
    "#dc2626", // è“æœçº¢
    "#f59e0b", // æ©˜å­æ©™
    "#facc15", // æŸ æª¬é»„
    "#4ade80", // è‹¹æœç»¿
    "#22d3ee", // å†°æ²³è“
    "#3b82f6", // æµ·æ´‹è“
    "#a855f7", // è‘¡è„ç´«
    "#f472b6", // èœœæ¡ƒç²‰
    "#57534e", // å’–å•¡æ£•
  ];

  const KEY_SAVE = 'gummy_v8_save';
  
  let state = { level: 1, pairCount: 3, colors: [], answer: [], rows: [], activeRow: 0, sound: true };
  
  /* --- ä¿®å¤ç‰ˆéŸ³é¢‘ç³»ç»Ÿ --- */
  const audios = { 
    bg: document.getElementById('bg-soda'), 
    pop: document.getElementById('sfx-pop'), 
    correct: document.getElementById('sfx-correct') 
  };
  let audioReady = false;

  // 1. åˆå§‹åŒ–æ—¶é™ä½éŸ³é‡
  Object.values(audios).forEach(a => { a.volume = 0; });

  // 2. å¼ºåŠ›è§£é”å‡½æ•°ï¼šæ’­æ”¾æ‰€æœ‰éŸ³é¢‘ä¸€ç¬é—´
  function initAudioSystem() {
    if (audioReady) return;
    
    const playPromises = Object.values(audios).map(a => {
        a.muted = true; // å…ˆé™éŸ³é˜²æ­¢çˆ†éŸ³
        const p = a.play();
        if (p !== undefined) {
            return p.then(() => {
                a.pause();
                a.currentTime = 0;
                a.muted = false; // è§£é™¤é™éŸ³
                // æ¢å¤æ­£å¸¸éŸ³é‡
                if(a.id === 'bg-soda') a.volume = 0.3; else a.volume = 1; 
            }).catch(e => console.warn("Audio warmup failed", e));
        }
    });

    Promise.all(playPromises).then(() => {
        audioReady = true;
        if(state.sound) audios.bg.play().catch(()=>{});
    });

    // ç§»é™¤ç›‘å¬
    document.removeEventListener('touchstart', initAudioSystem);
    document.removeEventListener('click', initAudioSystem);
  }

  // ç›‘å¬æ‰€æœ‰äº¤äº’ä»¥è§£é”éŸ³é¢‘
  document.addEventListener('touchstart', initAudioSystem, {capture:true, once:true});
  document.addEventListener('click', initAudioSystem, {capture:true, once:true});

  function playSound(key) {
    if (!state.sound) return;
    const a = audios[key];
    if (a) {
        a.currentTime = 0;
        // å†æ¬¡ç¡®ä¿è§£é™¤é™éŸ³å’ŒéŸ³é‡æ­£ç¡®
        a.muted = false;
        a.volume = 1;
        a.play().catch(e => console.warn("Play failed", e));
    }
  }

  /* --- æ¸¸æˆé€»è¾‘ --- */
  function initGame() {
    const savedLvl = localStorage.getItem(KEY_SAVE);
    state.level = savedLvl ? parseInt(savedLvl) : 1;
    startLevel();
  }
  function getPairCount(lvl) {
    if (lvl === 1) return 3;
    if (lvl === 2) return 4;
    return Math.min(4 + Math.floor((lvl - 1) / 3), 5); // é™åˆ¶æœ€å¤š5ä¸ªï¼Œä¸ºäº†ä¸æ¢è¡Œï¼Œä¿æŒç¾è§‚
  }
  function startLevel() {
    state.pairCount = getPairCount(state.level);
    const pool = COLORS.map((_, i) => i).sort(() => Math.random() - 0.5);
    state.colors = pool.slice(0, state.pairCount);
    state.answer = [...state.colors].sort(() => Math.random() - 0.5);
    state.rows = [{ guess: Array(state.pairCount).fill(null), status: 'active', residue: [] }];
    state.activeRow = 0;
    renderUI(); adjustSize();
  }

  function handleGuess(rowIdx, slotIdx, colorId) {
    const row = state.rows[rowIdx];
    if (row.status !== 'active') return;
    const existIdx = row.guess.indexOf(colorId);
    if (existIdx !== -1 && existIdx !== slotIdx) row.guess[existIdx] = null;
    row.guess[slotIdx] = colorId;
    renderBoard();
    if (row.guess.every(c => c !== null)) checkRow(row);
  }

  function checkRow(row) {
    const isCorrect = row.guess.every((c, i) => c === state.answer[i]);
    if (isCorrect) {
        row.status = 'win'; playSound('correct'); renderBoard();
        setTimeout(() => { state.level++; localStorage.setItem(KEY_SAVE, state.level); startLevel(); }, 1200);
    } else {
        row.status = 'bad'; playSound('pop');
        row.guess.forEach((cid, i) => { if (cid !== state.answer[i]) row.residue[i] = COLORS[cid]; });
        renderBoard();
        setTimeout(() => {
            state.rows.push({ guess: Array(state.pairCount).fill(null), status: 'active', residue: [] });
            state.activeRow++; renderBoard();
            const el = document.getElementById('attempts'); 
            // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' }), 50);
        }, 600);
    }
  }

  /* --- æ¸²æŸ“ --- */
  function adjustSize() {
    // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´æ¯å­å¤§å°ï¼Œç¡®ä¿ä¸æ¢è¡Œ
    const w = Math.min(window.innerWidth, 420) - 20; 
    let sz = Math.floor((w - (state.pairCount - 1) * 8) / state.pairCount);
    sz = Math.min(50, sz); // æœ€å¤§é™åˆ¶
    
    document.documentElement.style.setProperty('--cup-w', sz + 'px');
    document.documentElement.style.setProperty('--cup-h', (sz * 1.1) + 'px');
    document.documentElement.style.setProperty('--candy-sz', (sz * 0.75) + 'px');
    document.documentElement.style.setProperty('--count', state.pairCount);
  }

  function renderUI() {
    document.getElementById('level').innerText = state.level;
    document.getElementById('pairs').innerText = state.pairCount;
    renderPalette(); renderBoard();
  }

  function renderPalette() {
    const p = document.getElementById('palette'); p.innerHTML = '';
    const activeRow = state.rows[state.activeRow];
    const used = new Set(activeRow ? activeRow.guess : []);
    
    state.colors.forEach(cid => {
        const wrap = document.createElement('div'); wrap.className = 'p-item';
        const c = document.createElement('div'); c.className = 'candy palette-candy';
        c.style.setProperty('--bg', COLORS[cid]);
        if (used.has(cid)) c.classList.add('used');
        c.addEventListener('touchstart', (e) => handleTouchStart(e, c, cid), {passive: false});
        wrap.appendChild(c); p.appendChild(wrap);
    });
  }

  function renderBoard() {
    const board = document.getElementById('attempts'); board.innerHTML = '';
    state.rows.forEach((row, rIdx) => {
        const card = document.createElement('div');
        card.className = 'row-card' + (rIdx === state.activeRow ? ' active' : '');
        const slots = document.createElement('div'); slots.className = 'slots';
        
        for(let sIdx=0; sIdx<state.pairCount; sIdx++) {
            const cid = row.guess[sIdx];
            const cup = document.createElement('div');
            cup.className = 'cup'; cup.dataset.r = rIdx; cup.dataset.s = sIdx;
            
            if (row.residue[sIdx]) {
                const res = document.createElement('div'); res.className = 'residue-layer';
                res.style.setProperty('--c', row.residue[sIdx]); cup.appendChild(res);
            }
            if (cid !== null) {
                const c = document.createElement('div');
                c.className = (row.status === 'bad' && cid !== state.answer[sIdx]) ? 'candy fade-out' : 'candy';
                c.style.setProperty('--bg', COLORS[cid]); cup.appendChild(c);
            }
            slots.appendChild(cup);
        }
        card.appendChild(slots); board.appendChild(card);
    });
  }

  /* --- äº¤äº’ --- */
  let ghost = null, dragId = null, activeColor = null, hoverCup = null, sourceEl = null;

  function handleTouchStart(e, el, cid) {
    if(el.classList.contains('used')) return;
    e.preventDefault();
    const t = e.changedTouches[0]; 
    dragId = t.identifier; activeColor = cid; sourceEl = el;
    
    sourceEl.classList.add('dragging-source');

    ghost = el.cloneNode(true);
    ghost.className = 'candy drag-ghost';
    ghost.classList.remove('dragging-source', 'palette-candy');
    ghost.style.setProperty('--bg', COLORS[cid]);
    ghost.style.left = t.clientX + 'px'; ghost.style.top = t.clientY + 'px';
    document.body.appendChild(ghost);
  }

  document.addEventListener('touchmove', (e) => {
    if (!ghost) return;
    const t = Array.from(e.changedTouches).find(x => x.identifier === dragId);
    if (!t) return;
    e.preventDefault();
    ghost.style.left = t.clientX + 'px'; ghost.style.top = t.clientY + 'px';
    
    const elUnder = document.elementFromPoint(t.clientX, t.clientY);
    const cup = elUnder ? elUnder.closest('.cup') : null;
    if (cup && parseInt(cup.dataset.r) === state.activeRow) {
        if (hoverCup !== cup) {
            if (hoverCup) hoverCup.classList.remove('dropHover');
            cup.classList.add('dropHover'); hoverCup = cup;
        }
    } else if (hoverCup) { hoverCup.classList.remove('dropHover'); hoverCup = null; }
  }, {passive: false});

  const endDrag = () => {
    if (ghost) { ghost.remove(); ghost = null; }
    if (sourceEl) { sourceEl.classList.remove('dragging-source'); sourceEl = null; }
    dragId = null;
    if (hoverCup) {
        hoverCup.classList.remove('dropHover');
        handleGuess(parseInt(hoverCup.dataset.r), parseInt(hoverCup.dataset.s), activeColor);
        hoverCup = null;
    }
  };
  document.addEventListener('touchend', endDrag);
  document.addEventListener('visibilitychange', () => { if (document.hidden) endDrag(); });

  /* --- æ‚é¡¹ --- */
  const bg = document.getElementById("bgBubbles");
  for(let i=0;i<15;i++){
    const b = document.createElement("div"); b.className = "bubble";
    const size = 10 + Math.random()*20;
    b.style.setProperty("--size", size+"px"); b.style.setProperty("--x", Math.random()*100 + "vw");
    b.style.setProperty("--dur", (10+Math.random()*15)+"s");
    bg.appendChild(b);
  }

  document.getElementById('soundBtn').onclick = function() {
    state.sound = !state.sound; this.innerText = state.sound ? 'ğŸ”Š' : 'ğŸ”‡';
    if(state.sound && audioReady) audios.bg.play().catch(()=>{}); else audios.bg.pause();
  };
  // ç»‘å®šé‡ç½®æŒ‰é’®
  document.getElementById('resetBtn').onclick = () => {
      // ç®€å•éœ‡åŠ¨åé¦ˆ
      if(navigator.vibrate) navigator.vibrate(50);
      startLevel();
  };

  window.addEventListener('resize', adjustSize);
  initGame();
  if ("serviceWorker" in navigator) window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
})();
</script>
</body>
</html>
