<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœæ±è½¯ç³–é…å¯¹</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1330">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text:#e5e7eb;
      --panel:rgba(17,24,39,.62);
      --blue:rgba(59,130,246,.95);
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans CJK SC",sans-serif;
      color:var(--text);
      overflow:hidden;

      background:
        radial-gradient(900px 520px at 35% 10%, rgba(255,255,255,.16), transparent 55%),
        radial-gradient(820px 520px at 75% 15%, rgba(255,255,255,.10), transparent 58%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg,#0b1330 0%,#0b2a3a 30%,#0a3a4a 55%,#0a2b43 100%);
    }

    /* ===== èƒŒæ™¯æ³¡æ³¡ ===== */
    .bg-bubbles{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
    .bubble{
      position:absolute; bottom:-60px; border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 55% 65%, rgba(255,255,255,.10), rgba(255,255,255,0) 62%);
      border:1px solid rgba(255,255,255,.18);
      opacity:.55;
      animation: rise var(--dur) linear infinite, sway var(--sway) ease-in-out infinite;
      left: var(--x);
      width: var(--size);
      height: var(--size);
      animation-delay: var(--delay);
    }
    @keyframes rise{ from{ transform: translateY(0); } to{ transform: translateY(-110vh); } }
    @keyframes sway{ 0%,100%{ margin-left:0; } 50%{ margin-left:var(--sx); } }

    /* ===== ä¸»ç•Œé¢ ===== */
    .wrap{ width:min(1040px, 94vw); position:relative; z-index:1; }
    header{
      display:flex; flex-wrap:wrap;
      justify-content:space-between; align-items:center;
      gap:12px; margin-bottom:14px;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; text-shadow:0 10px 30px rgba(0,0,0,.35); }
    .meta{
      display:flex; flex-wrap:wrap; gap:12px;
      color:rgba(226,232,240,.85); font-size:13px; align-items:center;
    }
    .btn{
      background:rgba(31,41,55,.72);
      color:var(--text);
      border:1px solid rgba(148,163,184,.28);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .btn:hover{ filter:brightness(1.08); }

    .panel{
      background: var(--panel);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      touch-action: none;
    }

    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }

    .attemptArea{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
      background: rgba(0,0,0,.10);
    }

    .attempts{
      height: 560px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding-right:6px;
    }

    .rowCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .rowCard.active{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.06),
        0 10px 28px rgba(0,0,0,.20);
      outline: none;
    }

    .slots{
      display:grid;
      gap:14px;
      justify-items:start;
      align-items:center;
    }
    .slots[data-count="3"]{ grid-template-columns: repeat(3, 90px); }
    .slots[data-count="4"]{ grid-template-columns: repeat(4, 90px); }
    .slots[data-count="5"]{ grid-template-columns: repeat(5, 90px); }
    .slots[data-count="6"]{ grid-template-columns: repeat(6, 90px); }
    .slots[data-count="7"]{ grid-template-columns: repeat(7, 90px); }
    .slots[data-count="8"]{ grid-template-columns: repeat(8, 90px); }
    .slots[data-count="9"]{ grid-template-columns: repeat(9, 90px); }

    /* ===== ç»ç’ƒæ¯ ===== */
    .cup{
      width:90px; height:86px; border-radius:999px;
      position:relative; overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow:
        inset 0 18px 26px rgba(0,0,0,.30),
        inset 0 -18px 30px rgba(255,255,255,.04),
        0 14px 28px rgba(0,0,0,.30);
      backdrop-filter: blur(2px);
    }
    .cup::before{
      content:"";
      position:absolute; inset:8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      opacity:.9; z-index:30; pointer-events:none;
    }
    .cup::after{
      content:"";
      position:absolute; left:10px; top:10px;
      width:28%; height:68%; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
      opacity:.9; z-index:30; pointer-events:none;
      filter: blur(.2px);
    }
    .cup.dropHover{
      outline:2px solid var(--blue);
      outline-offset:6px;
    }

    /* é”™è¯¯æ®‹ç•™ï¼ˆç•™åœ¨æ¯é‡Œï¼‰ */
    .cup .residue{
      position:absolute;
      inset:12px;
      border-radius:999px;
      background:
        radial-gradient(40% 30% at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(60% 50% at 65% 60%, rgba(0,0,0,.25), transparent 70%),
        radial-gradient(circle at 50% 65%, var(--residue) 0 55%, transparent 75%);
      opacity:.72;
      filter: blur(1px);
      z-index:4;
      pointer-events:none;
    }

    /* ===== æ¤­åœ†è½¯ç³– ===== */
    .candy{
      width:78px; height:58px; border-radius:999px;
      position:relative; overflow:hidden;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        inset 0 10px 16px rgba(255,255,255,.20),
        inset 0 -16px 20px rgba(0,0,0,.18),
        0 10px 18px rgba(0,0,0,.26);
      backdrop-filter: blur(2px);
      transform: translateZ(0);
      user-select:none;
      z-index:10;
    }
    .candy::before{
      content:"";
      position:absolute; left:10px; top:7px;
      width:54%; height:55%;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 65%);
      transform: rotate(-12deg);
      opacity:.95; pointer-events:none;
    }
    .candy::after{
      content:"";
      position:absolute; inset:-26px;
      background:
        radial-gradient(circle at 24% 34%, rgba(255,255,255,.16) 0 5px, transparent 6px),
        radial-gradient(circle at 78% 40%, rgba(255,255,255,.12) 0 4px, transparent 5px),
        radial-gradient(circle at 48% 78%, rgba(255,255,255,.10) 0 5px, transparent 6px);
      opacity:.9; pointer-events:none;
    }

    .paletteCandy{ cursor:grab; }
    .paletteCandy:active{ cursor:grabbing; }
    .paletteCandy{ touch-action: none;}
    .used{ opacity:.42; filter:saturate(.7); }
    .cupCandy{ position:absolute; left:6px; top:14px; cursor:default; }

    /* ===== ç³–æœæ± ï¼ˆåªæ˜¾ç¤ºç³–æœæœ¬ä½“ï¼šæ— å¤–æ¡†ã€æ— æ–‡å­—ï¼‰ ===== */
    .paletteCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
      background: rgba(0,0,0,.10);
    }
    .paletteRow{
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding:6px 2px 0 2px;
    }
    .paletteRow::-webkit-scrollbar{ height:10px; }
    .paletteRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.08); border-radius:999px; }

    .paletteItem{
      border:none !important;
      background:transparent !important;
      box-shadow:none !important;
      padding:0 !important;
      min-width:0 !important;
      display:flex;
      align-items:center;
      gap:0;
    }
    .label{ display:none !important; }

    /* ===== çˆ†å¼€åŠ¨ç”» ===== */
    .pop{ animation: pop 260ms ease-out forwards; z-index:12; }
    @keyframes pop{
      0%{ transform: translate(0,0) scale(1); opacity:1; filter:saturate(1) blur(0); }
      60%{ transform: translate(0,-2px) scale(1.06); opacity:.9; filter:saturate(1.2) blur(.2px); }
      100%{ transform: translate(0,6px) scale(.18); opacity:0; filter:saturate(.8) blur(1.2px); }
    }

    .splat{
      position:absolute;
      inset:10px;
      border-radius: 46% 54% 55% 45% / 52% 46% 54% 48%;
      background: var(--splat);
      opacity:.92;
      filter: blur(.3px);
      z-index:6;
      transform: rotate(var(--rot));
      box-shadow:
        0 8px 18px rgba(0,0,0,.22),
        inset 0 10px 16px rgba(255,255,255,.10);
    }
    .drip{
      position:absolute;
      width:10px; height:22px;
      border-radius:999px;
      background: var(--splat);
      opacity:.90;
      z-index:6;
      filter: blur(.15px);
      transform-origin: top;
      animation: drip 520ms ease-out forwards;
      box-shadow: inset 0 6px 10px rgba(255,255,255,.10);
    }
    @keyframes drip{ from{ transform:scaleY(.2); opacity:0; } to{ transform:scaleY(1); opacity:.90; } }

    .particle{
      position:absolute;
      width:6px; height:6px;
      border-radius:50%;
      pointer-events:none;
      z-index:20;
      opacity:.95;
      animation: fly 430ms ease-out forwards;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      background: var(--p);
    }
    @keyframes fly{
      to{ transform: translate(var(--dx), var(--dy)) scale(0); opacity:0; }
    }

    .attempts::-webkit-scrollbar{ width:10px; }
    .attempts::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.08);
      border-radius: 999px;
    }
    html, body {
   touch-action: manipulation;
   } 
  
   .candy {
    -webkit-user-select: none;
   user-select: none;
   -webkit-touch-callout: none;
   touch-action: none;
   }
  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <!-- åªä¿ç•™ 3 ä¸ªéŸ³é¢‘ï¼šsoda / pop / correct -->
  <audio id="bg-soda" preload="auto" loop></audio>
  <audio id="sfx-pop" preload="auto"></audio>
  <audio id="sfx-correct" preload="auto"></audio>

  <div class="wrap">
    <header>
      <h1>ğŸ§ƒğŸ¬ æœæ±è½¯ç³–é…å¯¹</h1>
      <div class="meta">
        <div>å…³å¡ï¼š<span id="level">1</span></div>
        <div>é…å¯¹ï¼š<span id="pairs">3</span></div>
        <div>å°è¯•ï¼š<span id="tries">0</span></div>

        <button class="btn" id="soundBtn">ğŸ”‡ å£°éŸ³å·²å…³é—­</button>
        <span id="soundDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#6b7280;vertical-align:middle;"></span>

        <button class="btn" id="resetLevel">é‡ç½®æœ¬å…³</button>
        <button class="btn" id="restart">ä»ç¬¬1å…³é‡å¼€</button>
      </div>
    </header>

    <div class="panel">
      <div class="grid">
        <div class="attemptArea">
          <div class="attempts" id="attempts"></div>
        </div>

        <div class="paletteCard">
          <div class="paletteRow" id="palette"></div>
        </div>
      </div>
    </div>
  </div>

<script>
    /**********************
     * å·¥å…·å‡½æ•°
     **********************/
    const $ = (sel, el=document) => el.querySelector(sel);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const randInt = (a, b) => Math.floor(Math.random()*(b-a+1))+a;
    const shuffle = (arr) => {
      for(let i=arr.length-1;i>0;i--){
        const j = (Math.random()*(i+1))|0;
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    /**********************
     * éŸ³é¢‘ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)
     * è§£å†³éŸ³ç”»ä¸åŒæ­¥å’Œçˆ†éŸ³é—®é¢˜
     **********************/
    const audioCtx = {
      pop: new Audio('./pop.mp3'),
      win: new Audio('./correct.mp3'),
      ui:  new Audio('./soda.mp3')
    };

    // é¢„åŠ è½½éŸ³é¢‘
    Object.values(audioCtx).forEach(a => {
      a.preload = 'auto';
      a.load();
    });

    function playSound(type="pop", volume=0.5){
      if(!persist.sound) return;
      
      let baseAudio;
      if(type === "win") baseAudio = audioCtx.win;
      else if(type === "ui") baseAudio = audioCtx.ui;
      else baseAudio = audioCtx.pop; // é»˜è®¤ç§»åŠ¨å£°éŸ³

      // å…‹éš†èŠ‚ç‚¹ä»¥æ”¯æŒå¹¶å‘æ’­æ”¾ï¼ˆå¿«é€Ÿè¿å‡»æ—¶ä¸ä¼šåˆ‡æ–­ä¸Šä¸€ä¸ªå£°éŸ³ï¼‰
      const sound = baseAudio.cloneNode();
      sound.volume = volume;
      sound.play().catch(e => console.warn("Audio play failed:", e));
    }

    /**********************
     * é¢œè‰²ç”Ÿæˆç®—æ³•
     **********************/
    const BASE_COLORS = [
      "#ff4d4d", "#ff9f1a", "#ffd93d",
      "#2bd9a2", "#2fb8ff", "#3b5bff",
      "#9b5cff", "#ff4fd8", "#9be15d"
    ];

    function hexToRgb(hex){
      const m = hex.replace("#","").trim();
      const v = parseInt(m.length===3 ? m.split("").map(x=>x+x).join("") : m, 16);
      return { r:(v>>16)&255, g:(v>>8)&255, b:v&255 };
    }

    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0,s=0,l=(max+min)/2;
      if(max!==min){
        const d=max-min;
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d + (g<b?6:0); break;
          case g: h=(b-r)/d + 2; break;
          case b: h=(r-g)/d + 4; break;
        }
        h*=60;
      }
      return {h,s,l};
    }

    function hslToHex(h,s,l){
      function hue2rgb(p,q,t){
        if(t<0) t+=1;
        if(t>1) t-=1;
        if(t<1/6) return p+(q-p)*6*t;
        if(t<1/2) return q;
        if(t<2/3) return p+(q-p)*(2/3 - t)*6;
        return p;
      }
      let r,g,b;
      if(s===0){ r=g=b=l; }
      else{
        const q = l<0.5 ? l*(1+s) : l+s-l*s;
        const p = 2*l-q;
        r = hue2rgb(p,q,(h/360)+1/3);
        g = hue2rgb(p,q,(h/360));
        b = hue2rgb(p,q,(h/360)-1/3);
      }
      const toHex = x => {
        const v = Math.round(x*255);
        return v.toString(16).padStart(2,"0");
      };
      return "#"+toHex(r)+toHex(g)+toHex(b);
    }

    function circularHueDist(a,b){
      const d = Math.abs(a-b)%360;
      return Math.min(d, 360-d);
    }

    function generateDistinctColors(totalNeeded){
      const colors = [...BASE_COLORS];
      if(totalNeeded <= colors.length) return colors.slice(0, totalNeeded);

      const hues = colors.map(c => rgbToHsl(...Object.values(hexToRgb(c))).h);
      const MIN_HUE_DIST = 22;
      const S_RANGE = [0.72, 0.92];
      const L_RANGE = [0.48, 0.62];

      let guard = 0;
      while(colors.length < totalNeeded && guard++ < 2000){
        const h = randInt(0,359);
        if(hues.some(x => circularHueDist(x,h) < MIN_HUE_DIST)) continue;

        const s = (Math.random()*(S_RANGE[1]-S_RANGE[0])+S_RANGE[0]);
        const l = (Math.random()*(L_RANGE[1]-L_RANGE[0])+L_RANGE[0]);
        const hex = hslToHex(h,s,l);

        const {r,g,b} = hexToRgb(hex);
        const tooClose = colors.some(c=>{
          const t = hexToRgb(c);
          const dr=r-t.r, dg=g-t.g, db=b-t.b;
          return (dr*dr+dg*dg+db*db) < 2400;
        });
        if(tooClose) continue;

        colors.push(hex);
        hues.push(h);
      }
      return colors;
    }

    /**********************
     * æ¸¸æˆçŠ¶æ€ + æŒä¹…åŒ–
     **********************/
    const STORAGE_KEY = "juiceMatch_v2";
    function loadPersist(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_){ return null; }
    }
    function savePersist(p){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }catch(_){}
    }

    const appEl = $("#app");
    const cupsRowEl = $("#cupsRow");
    const attemptsEl = $("#attempts");
    const lvlEl = $("#lvl");
    const countEl = $("#count");
    const triesEl = $("#tries");
    const soundBtn = $("#soundBtn");
    const resetBtn = $("#resetBtn");
    const restartBtn = $("#restartBtn");
    const hintEl = $("#hint");

    const isMobileLike = matchMedia("(pointer: coarse)").matches || matchMedia("(max-width: 520px)").matches;
    if(isMobileLike) appEl.classList.add("lowfx");

    const persist = loadPersist() || {
      level: 1,
      sound: true,
      best: {}
    };

    let level = clamp(persist.level || 1, 1, 999);
    let soundOn = !!persist.sound;

    let slotCount = 3;
    let palette = BASE_COLORS.slice();
    let secret = [];       
    let current = [];      
    let attempts = [];     
    let draggingIdx = null; 

    function setSoundUI(){
      soundBtn.textContent = soundOn ? "å£°éŸ³å·²å¼€å¯" : "å£°éŸ³å·²å…³é—­";
    }

    function computeSlotCount(lvl){
      if(lvl >= 22) return randInt(9,14);
      return clamp(2 + lvl, 3, 9);
    }

    function startLevel(lvl, keepAttempts=false){
      level = lvl;
      slotCount = computeSlotCount(level);

      palette = generateDistinctColors(14); // ç¡®ä¿é¢œè‰²åº“å……è¶³

      const ids = shuffle([...Array(palette.length).keys()]);
      secret = ids.slice(0, slotCount);
      current = shuffle(secret.slice());

      if(!keepAttempts) attempts = [];
      draggingIdx = null;
      attemptsEl.replaceChildren();

      const best = persist.best?.[String(level)];
      hintEl.textContent =
        isMobileLike
          ? `ç§»åŠ¨ç«¯ä¼˜åŒ–æ¨¡å¼ï¼šæ‹–æ‹½æ›´æµç•…ã€‚ç¬¬22å…³èµ·æ¯å…³éšæœº 9~14 æ¯ã€‚${best ? "æœ¬å…³æœ€ä½³ï¼š"+best+" æ¬¡" : ""}`
          : `æ‹–åŠ¨è½¯ç³–åˆ°æ¯å­ä¸­æ’åˆ—ï¼Œæäº¤ä¼šè‡ªåŠ¨è®°å½•ç»“æœã€‚ç¬¬22å…³èµ·æ¯å…³éšæœº 9~14 æ¯ã€‚${best ? "æœ¬å…³æœ€ä½³ï¼š"+best+" æ¬¡" : ""}`;

      renderTop();
      renderCups(true); // å¼ºåˆ¶é‡ç»˜
      renderAttemptsFull();
      persist.level = level;
      persist.sound = soundOn;
      savePersist(persist);
    }

    /**********************
     * æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤å®šä¸æ¸²æŸ“
     **********************/
    function gradeGuess(guess){
      const n = secret.length;
      const marks = Array(n).fill(0);
      const secretLeft = secret.slice();
      const guessLeft = guess.slice();

      for(let i=0;i<n;i++){
        if(guessLeft[i] === secretLeft[i]){
          marks[i] = 2;
          secretLeft[i] = -1;
          guessLeft[i] = -2;
        }
      }
      for(let i=0;i<n;i++){
        if(guessLeft[i] < 0) continue;
        const j = secretLeft.indexOf(guessLeft[i]);
        if(j !== -1){
          marks[i] = 1;
          secretLeft[j] = -1;
        }
      }
      return marks;
    }

    function isWin(marks){
      return marks.every(m => m===2);
    }

    function renderTop(){
      lvlEl.textContent = String(level);
      countEl.textContent = String(slotCount);
      triesEl.textContent = String(attempts.length);
      setSoundUI();
    }

    /**
     * æ¸²æŸ“æ¯å­åŒºåŸŸ (ä¼˜åŒ–ç‰ˆ)
     * forceRebuild: true åˆ™å®Œå…¨é‡ç½® DOM (å…³å¡å¼€å§‹æ—¶)
     * forceRebuild: false åˆ™ä»…æ›´æ–°é¢œè‰² (äº¤æ¢ä½ç½®æ—¶)
     */
    function renderCups(forceRebuild = false){
      // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶é‡å»ºï¼ˆå¦‚æœDOMæ•°é‡ä¸å¯¹ï¼Œä¹Ÿå¼ºåˆ¶é‡å»ºï¼‰
      const existingCups = cupsRowEl.querySelectorAll(".cup");
      const shouldRebuild = forceRebuild || existingCups.length !== slotCount;

      if(shouldRebuild){
        cupsRowEl.replaceChildren(); // æ¸…ç©º

        for(let i=0; i<slotCount; i++){
          const cup = document.createElement("div");
          cup.className = "cup";
          cup.dataset.pos = String(i);

          const candy = document.createElement("div");
          candy.className = "cupCandy";
          candy.draggable = !isMobileLike; 
          candy.dataset.pos = String(i);
          
          // ç«‹å³åº”ç”¨é¢œè‰²ï¼Œé˜²æ­¢"æ¶ˆå¤±"
          applyCandyStyle(candy, current[i]);

          // --- Desktop Drag ---
          candy.addEventListener("dragstart", (e)=>{
            draggingIdx = i;
            candy.classList.add("dragging");
            e.dataTransfer.setData("text/plain", String(i));
            e.dataTransfer.effectAllowed = "move";
          });
          candy.addEventListener("dragend", ()=>{
            draggingIdx = null;
            candy.classList.remove("dragging");
            clearDropTargets();
          });

          // --- Drop Logic ---
          cup.addEventListener("dragover", (e)=>{
            e.preventDefault();
            cup.classList.add("dropTarget");
          });
          cup.addEventListener("dragleave", ()=>{
            cup.classList.remove("dropTarget");
          });
          cup.addEventListener("drop", (e)=>{
            e.preventDefault();
            cup.classList.remove("dropTarget");
            const from = parseInt(e.dataTransfer.getData("text/plain") || "-1", 10);
            handleSwap(from, i);
          });

          // --- Mobile Touch (GPU Accelerated Ghost) ---
          if(isMobileLike){
            let touchId = null;
            let ghost = null;
            
            candy.addEventListener("touchstart", (e)=>{
              const t = e.changedTouches[0];
              touchId = t.identifier;
              draggingIdx = i;

              // åˆ›å»ºé•œåƒ (Ghost)
              ghost = candy.cloneNode(true);
              ghost.style.position = "fixed";
              ghost.style.left = "0"; 
              ghost.style.top = "0";
              ghost.style.zIndex = "9999";
              ghost.style.pointerEvents = "none";
              ghost.style.opacity = "0.9";
              // å…³é”®ï¼šè®¡ç®—åˆå§‹åç§»ï¼Œé˜²æ­¢è·³å˜
              const rect = candy.getBoundingClientRect();
              ghost.dataset.startX = t.clientX - rect.left;
              ghost.dataset.startY = t.clientY - rect.top;
              // åˆå§‹ä½ç½®
              ghost.style.transform = `translate(${rect.left}px, ${rect.top}px) scale(1.05)`;
              
              document.body.appendChild(ghost);
            }, {passive:true});

            candy.addEventListener("touchmove", (e)=>{
              if(touchId==null || !ghost) return;
              const t = [...e.changedTouches].find(x=>x.identifier===touchId);
              if(!t) return;

              // ä½¿ç”¨ translate ç§»åŠ¨ï¼Œä¸è§¦å‘é‡æ’ï¼Œæå¤§æå‡æ€§èƒ½
              const x = t.clientX - parseFloat(ghost.dataset.startX);
              const y = t.clientY - parseFloat(ghost.dataset.startY);
              ghost.style.transform = `translate(${x}px, ${y}px) scale(1.05)`;

              // é«˜äº®ç›®æ ‡
              const el = document.elementFromPoint(t.clientX, t.clientY);
              const targetCup = el?.closest?.(".cup");
              clearDropTargets();
              if(targetCup) targetCup.classList.add("dropTarget");
            }, {passive:true});

            candy.addEventListener("touchend", (e)=>{
              if(touchId==null) return;
              const t = [...e.changedTouches].find(x=>x.identifier===touchId);
              touchId = null;

              let targetCup = null;
              if(t){
                const el = document.elementFromPoint(t.clientX, t.clientY);
                targetCup = el?.closest?.(".cup");
              }
              
              clearDropTargets();
              if(targetCup){
                const to = parseInt(targetCup.dataset.pos, 10);
                handleSwap(draggingIdx, to);
              }
              
              draggingIdx = null;
              ghost && ghost.remove();
              ghost = null;
            }, {passive:true});
          }

          cup.appendChild(candy);
          cupsRowEl.appendChild(cup);
        }

        // æ·»åŠ æŒ‰é’®
        const actions = document.createElement("div");
        actions.style.marginTop = "10px";
        actions.style.display = "flex";
        actions.style.gap = "10px";
        actions.style.flexWrap = "wrap";

        const submit = document.createElement("button");
        submit.className = "btn";
        submit.textContent = "æäº¤æœ¬æ¬¡æ’åˆ—";
        submit.addEventListener("click", submitGuess);

        const shuffleBtn = document.createElement("button");
        shuffleBtn.className = "btn";
        shuffleBtn.textContent = "éšæœºæ‰“ä¹±";
        shuffleBtn.addEventListener("click", ()=>{
          playSound("ui");
          shuffle(current);
          renderCups(false); // ä»…æ›´æ–°é¢œè‰²
        });

        actions.appendChild(submit);
        actions.appendChild(shuffleBtn);
        cupsRowEl.appendChild(actions);

      } else {
        // --- å¿«é€Ÿæ›´æ–°æ¨¡å¼ (Dom å¤ç”¨) ---
        const cups = cupsRowEl.querySelectorAll(".cup");
        for(let i=0; i<slotCount; i++){
            const candy = cups[i].querySelector(".cupCandy");
            if(candy) applyCandyStyle(candy, current[i]);
        }
      }
    }

    // è¾…åŠ©ï¼šå®‰å…¨åº”ç”¨æ ·å¼
    function applyCandyStyle(el, colorIdx){
        if(palette[colorIdx]){
            el.style.background = `linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.06)), ${palette[colorIdx]}`;
            el.dataset.color = String(colorIdx);
            // ç¡®ä¿æ²¡æœ‰è¢«éšè—
            el.style.display = "flex"; 
            el.style.opacity = "1";
        }
    }

    function clearDropTargets(){
        [...cupsRowEl.querySelectorAll(".cup")].forEach(x=>x.classList.remove("dropTarget"));
    }

    function handleSwap(from, to){
        if(Number.isFinite(from) && from>=0 && from<slotCount && to>=0 && to<slotCount && from!==to){
            [current[from], current[to]] = [current[to], current[from]];
            playSound("pop", 0.6);
            renderCups(false); // ä»…æ›´æ–°é¢œè‰²ï¼Œä¸é‡ç»˜ DOM
        }
    }

    function renderAttemptsFull(){
      for(const a of attempts){
        appendAttemptRow(a);
      }
    }

    function appendAttemptRow(attempt){
      const row = document.createElement("div");
      row.className = "row";
      
      const meta = document.createElement("div");
      meta.className = "rowMeta";
      meta.innerHTML = `<span class="pill">ç¬¬ ${attemptsEl.children.length+1} æ¬¡</span>`;

      const guessRow = document.createElement("div");
      guessRow.className = "guessRow";

      for(let i=0;i<slotCount;i++){
        const mc = document.createElement("div");
        mc.className = "miniCup";
        const candy = document.createElement("div");
        candy.className = "miniCandy";
        candy.style.background = `linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.05)), ${palette[attempt.guess[i]]}`;
        mc.appendChild(candy);
        guessRow.appendChild(mc);
      }

      const marks = document.createElement("div");
      marks.className = "markRow";
      for(let i=0;i<slotCount;i++){
        const d = document.createElement("div");
        d.className = "dot " + (attempt.marks[i]===2 ? "correct" : attempt.marks[i]===1 ? "misplaced" : "wrong");
        marks.appendChild(d);
      }

      row.appendChild(meta);
      row.appendChild(guessRow);
      row.appendChild(marks);
      attemptsEl.appendChild(row);
      attemptsEl.scrollTop = attemptsEl.scrollHeight;
    }

    /**********************
     * æäº¤ä¸ç»“ç®—
     **********************/
    function popBlurOnMobile(){
      if(!isMobileLike) return;
      const candies = cupsRowEl.querySelectorAll(".cupCandy");
      candies.forEach(el=>{
        el.classList.remove("blurPop");
        void el.offsetWidth; // è§¦å‘é‡ç»˜
        el.classList.add("blurPop");
      });
    }

    function submitGuess(){
      const guess = current.slice();
      const marks = gradeGuess(guess);

      attempts.push({guess, marks});
      renderTop();
      appendAttemptRow({guess, marks});

      if(soundOn){
        if(isWin(marks)) playSound("win", 0.8);
        else playSound("pop", 0.4);
      }
      if(!isWin(marks)) popBlurOnMobile();

      if(isWin(marks)){
        const used = attempts.length;
        const key = String(level);
        const best = persist.best[key];
        if(!best || used < best) persist.best[key] = used;
        persist.level = level + 1;
        persist.sound = soundOn;
        savePersist(persist);
        setTimeout(()=>startLevel(level+1), 450);
      }else{
        persist.level = level;
        persist.sound = soundOn;
        savePersist(persist);
      }
    }

    /**********************
     * å…¨å±€æ§åˆ¶
     **********************/
    soundBtn.addEventListener("click", ()=>{
      soundOn = !soundOn;
      persist.sound = soundOn;
      savePersist(persist);
      setSoundUI();
      if(soundOn) playSound("ui");
    });

    resetBtn.addEventListener("click", ()=>{
      playSound("ui");
      startLevel(level);
    });

    restartBtn.addEventListener("click", ()=>{
      playSound("ui");
      persist.level = 1;
      persist.best = {};
      savePersist(persist);
      startLevel(1);
    });

    // åˆå§‹åŒ–
    setSoundUI();
    startLevel(level);
</script>
</body>
</html>


