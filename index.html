<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <title>Color Match Cups</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1630;
      --text:#e9eeff;
      --muted:#a8b0d6;
      --accent:#67d5ff;
      --danger:#ff5c77;
      --ok:#4cf0a6;

      --size:78px;
      --cupW:90px;
      --cupH:86px;
      --gap:14px;
      --radius:18px;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --shadow2: 0 8px 18px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, #122355 0%, rgba(18,35,85,0) 60%),
                  radial-gradient(900px 700px at 90% 10%, #202f6e 0%, rgba(32,47,110,0) 65%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }

    @media (max-width: 920px){
      .wrap{grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.07);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHeader{
      padding:16px 16px 12px;
      background: radial-gradient(1000px 400px at 0% 0%, rgba(103,213,255,.18), rgba(103,213,255,0) 60%);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title h1{
      font-size:16px;
      margin:0;
      letter-spacing:.4px;
      font-weight:700;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .panelBody{ padding:14px; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0;
    }

    .small{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    button{
      appearance:none;
      border:none;
      outline:none;
      cursor:pointer;
      background: rgba(103,213,255,.16);
      color:var(--text);
      border:1px solid rgba(103,213,255,.28);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:650;
      letter-spacing:.2px;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{ background: rgba(103,213,255,.22); border-color: rgba(103,213,255,.45); }
    button:active{ transform: translateY(1px) scale(.99); }
    button.secondary{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      color: var(--muted);
    }
    button.secondary:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    button.danger{
      background: rgba(255,92,119,.16);
      border-color: rgba(255,92,119,.28);
    }
    button.danger:hover{ background: rgba(255,92,119,.22); border-color: rgba(255,92,119,.40); }

    .divider{
      height:1px;
      background: rgba(255,255,255,.07);
      margin:12px 0;
    }

    /* Game area */
    .game{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:560px;
    }

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: radial-gradient(900px 300px at 100% 0%, rgba(76,240,166,.12), rgba(76,240,166,0) 70%);
    }

    .status{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .status .big{
      font-weight:800;
      letter-spacing:.25px;
    }
    .status .sub{
      font-size:12px;
      color:var(--muted);
    }

    .attemptArea{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .attempts{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:12px;
      height:560px;
      overflow:auto;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }

    .rowCard{
      padding:12px;
      border-radius:16px;
      margin-bottom:10px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }

    .rowHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .rowHead .label{
      font-size:12px;
      color:var(--muted);
    }
    .rowHead .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted);
    }
    .pill.ok{ border-color: rgba(76,240,166,.30); color: rgba(76,240,166,.92); background: rgba(76,240,166,.10); }
    .pill.bad{ border-color: rgba(255,92,119,.30); color: rgba(255,92,119,.92); background: rgba(255,92,119,.10); }

    .slots{
      display:grid;
      gap:12px;
      justify-content:center;
      align-items:center;
    }
    .slots[data-count="3"]{ grid-template-columns: repeat(3, 90px); }
    .slots[data-count="4"]{ grid-template-columns: repeat(4, 90px); }
    .slots[data-count="5"]{ grid-template-columns: repeat(5, 90px); }
    .slots[data-count="6"]{ grid-template-columns: repeat(6, 90px); }
    .slots[data-count="7"]{ grid-template-columns: repeat(7, 90px); }
    .slots[data-count="8"]{ grid-template-columns: repeat(8, 90px); }
    .slots[data-count="9"]{ grid-template-columns: repeat(9, 90px); }

    .cup{
      width:90px;
      height:86px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .cup::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%);
      transform: rotate(10deg);
      pointer-events:none;
    }

    .cupTarget{
      width:72px;
      height:46px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }

    .cupCandy{
      position:absolute;
      width:78px;
      height:58px;
      left:6px;
      top:14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.24);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      transform: translateZ(0);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .candy{
      width:78px;
      height:58px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.26);
      box-shadow: 0 14px 28px rgba(0,0,0,.35);
      cursor:grab;
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      touch-action:none;
    }
    .candy::after{
      content:"";
      position:absolute;
      inset:-35%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .candy:active{ cursor:grabbing; }

    .tray{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:10px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      min-height:80px;
      align-items:center;
      justify-content:flex-start;
    }

    .tray .hint{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border:1px dashed rgba(255,255,255,.10);
    }

    .pop{
      animation: popOut .28s ease forwards;
    }
    @keyframes popOut{
      to{ transform: scale(.2); opacity:0; filter: blur(6px); }
    }

    /* splat */
    .splat{
      position:absolute;
      width:22px;
      height:22px;
      border-radius: 50%;
      opacity:.9;
      filter: blur(.2px);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      transform: scale(.6);
      animation: splat .32s ease forwards;
      pointer-events:none;
    }
    @keyframes splat{
      to{ transform: scale(1); opacity:.55; }
    }

    .particle{
      position:absolute;
      width:10px;
      height:10px;
      border-radius: 50%;
      opacity:.95;
      pointer-events:none;
      animation: fly .55s ease-out forwards;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    @keyframes fly{
      to{
        transform: translate(var(--dx), var(--dy)) scale(.2);
        opacity:0;
        filter: blur(4px);
      }
    }

    /* Footer in panel */
    .foot{
      padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      background: rgba(0,0,0,.06);
    }

    /* Select */
    select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      outline:none;
      font-weight:600;
      letter-spacing:.2px;
    }
    select option{ background:#0b1020; color:#e9eeff; }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:10px 12px;
    }
    .kpi .card .num{
      font-weight:850;
      font-size:18px;
      margin-top:2px;
    }

    /* Tooltip bubble for dragged candy */
    .dragGhost{
      position:fixed;
      pointer-events:none;
      z-index:9999;
      width: var(--size);
      height: calc(var(--size) * .74);
      border-radius: 16px;
      box-shadow: 0 18px 38px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.26);
      transform: translate(-50%, -50%);
      opacity:.95;
    }

    .pulse{
      animation: pulse .9s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.02); }
    }

    /* Win flash */
    .flash{
      animation: flash .45s ease;
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 rgba(76,240,166,0); }
      60%{ box-shadow: 0 0 0 8px rgba(76,240,166,.20); }
      100%{ box-shadow: 0 0 0 rgba(76,240,166,0); }
    }

    /* Disable selection */
    .noselect{ user-select:none; }

    /* Smooth scroll attempts */
    .attempts{ scroll-behavior:smooth; }

    /* ===============================
       Mobile/Responsive sizing + blur-wrong effect
       (added to improve phone performance & fit)
       =============================== */

    /* 错误提示：糊化（无爆开动画） */
    .blurWrong{
      filter: blur(4px);
      opacity: .55;
    }

    /* Responsive sizing override */
    :root{
      /* 杯子宽：会随屏幕缩放（小屏变小，大屏不超过原来的 90px） */
      --cupW: clamp(52px, 9.6vw, 90px);
      --cupH: calc(var(--cupW) * 0.96);

      /* 糖果尺寸跟随杯子 */
      --candyW: calc(var(--cupW) * 0.86);
      --candyH: calc(var(--cupW) * 0.64);

      /* 间距也跟着缩放 */
      --slotGap: clamp(8px, 1.6vw, 14px);
    }

    /* 覆盖固定像素 */
    .cup{
      width: var(--cupW) !important;
      height: var(--cupH) !important;
    }
    .candy{
      width: var(--candyW) !important;
      height: var(--candyH) !important;
    }

    /* 杯子里糖果的位置微调（避免小屏偏移） */
    .cupCandy{
      left: calc(var(--cupW) * 0.07) !important;
      top:  calc(var(--cupW) * 0.16) !important;
    }

    /* 覆盖 slots 固定列宽：3~9 都用杯子宽 */
    .slots{ gap: var(--slotGap) !important; }
    .slots[data-count="3"]{ grid-template-columns: repeat(3, var(--cupW)) !important; }
    .slots[data-count="4"]{ grid-template-columns: repeat(4, var(--cupW)) !important; }
    .slots[data-count="5"]{ grid-template-columns: repeat(5, var(--cupW)) !important; }
    .slots[data-count="6"]{ grid-template-columns: repeat(6, var(--cupW)) !important; }
    .slots[data-count="7"]{ grid-template-columns: repeat(7, var(--cupW)) !important; }
    .slots[data-count="8"]{ grid-template-columns: repeat(8, var(--cupW)) !important; }
    .slots[data-count="9"]{ grid-template-columns: repeat(9, var(--cupW)) !important; }

    /* 小屏允许自动换行（8/9 杯不会硬挤出屏幕）+ attempts 高度别写死 */
    @media (max-width: 520px){
      .slots{
        grid-template-columns: repeat(auto-fit, minmax(var(--cupW), 1fr)) !important;
        justify-items: center !important;
      }
      .attempts{
        height: min(62vh, 560px) !important;
      }
    }

  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left -->
    <section class="panel">
      <div class="panelHeader">
        <div class="title">
          <h1>颜色配对 · 杯子游戏</h1>
          <span class="badge">拖动色块到杯子</span>
        </div>
        <div class="kpi">
          <div class="card">
            <div class="small">关卡</div>
            <div class="num" id="kLevel">1</div>
          </div>
          <div class="card">
            <div class="small">杯子数</div>
            <div class="num" id="kCount">3</div>
          </div>
        </div>
      </div>

      <div class="panelBody">
        <div class="row">
          <div class="small">选择关卡（3~9杯）</div>
        </div>
        <select id="levelSelect"></select>

        <div class="btnRow">
          <button id="btnNew">新谜题</button>
          <button class="secondary" id="btnReset">重置本关</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="small">音效</div>
          <button class="secondary" id="btnSound">开启</button>
        </div>

        <div class="row">
          <div class="small">提示</div>
          <button class="secondary" id="btnHint">显示目标</button>
        </div>

        <div class="divider"></div>

        <div class="small">
          规则：把所有色块拖到正确杯子里。放错会提示并撤回错误位置。
        </div>
      </div>

      <div class="foot">
        移动端支持触屏拖拽。若感觉难拖，请轻点色块后拖动。
      </div>
    </section>

    <!-- Right -->
    <section class="panel game">
      <div class="topBar">
        <div class="status">
          <div class="big" id="statusBig">开始吧！</div>
          <div class="sub" id="statusSub">把下方色块拖到杯子里</div>
        </div>
        <div class="badge" id="attemptBadge">尝试：0</div>
      </div>

      <div class="attemptArea">
        <div class="row">
          <div class="small">色块托盘</div>
          <div class="small">（拖动/触摸拖动）</div>
        </div>
        <div class="tray noselect" id="tray">
          <div class="hint">把色块拖到杯子目标区</div>
        </div>

        <div class="row">
          <div class="small">尝试记录</div>
          <div class="small">从上到下</div>
        </div>
        <div class="attempts" id="attempts"></div>
      </div>
    </section>
  </div>

  <script>
    /***********************
     *  Data / Levels
     ***********************/
    const LEVELS = [
      { level:1, count:3 },
      { level:2, count:4 },
      { level:3, count:5 },
      { level:4, count:6 },
      { level:5, count:7 },
      { level:6, count:8 },
      { level:7, count:9 },
    ];

    // palette
    const COLORS = [
      "#ff4d6d", "#ff9f1c", "#ffd60a", "#4cf0a6", "#36a2ff",
      "#7c5cff", "#ff5cff", "#2de2e6", "#ff7bba"
    ];

    // state
    let state = {
      level: 1,
      count: 3,
      target: [],
      tray: [],
      placed: Array(9).fill(null),
      attempts: [],
      showHint: false,
      soundOn: true,
    };

    /***********************
     *  Elements
     ***********************/
    const elLevelSelect = document.getElementById("levelSelect");
    const elKLevel = document.getElementById("kLevel");
    const elKCount = document.getElementById("kCount");
    const elTray = document.getElementById("tray");
    const elAttempts = document.getElementById("attempts");
    const elStatusBig = document.getElementById("statusBig");
    const elStatusSub = document.getElementById("statusSub");
    const elAttemptBadge = document.getElementById("attemptBadge");

    const btnNew = document.getElementById("btnNew");
    const btnReset = document.getElementById("btnReset");
    const btnHint = document.getElementById("btnHint");
    const btnSound = document.getElementById("btnSound");

    /***********************
     *  Sound (tiny synth)
     ***********************/
    let audioCtx = null;
    function beep(freq=440, dur=0.08, type="sine", gain=0.08){
      if(!state.soundOn) return;
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + dur);
      }catch(e){}
    }
    function sfxCorrect(){
      beep(660,0.06,"triangle",0.09);
      setTimeout(()=>beep(990,0.06,"triangle",0.08), 60);
    }
    function sfxWrong(){
      beep(180,0.10,"sawtooth",0.10);
      setTimeout(()=>beep(120,0.08,"sawtooth",0.08), 80);
    }

    /***********************
     *  Init UI
     ***********************/
    function initSelect(){
      elLevelSelect.innerHTML = "";
      LEVELS.forEach(l=>{
        const opt = document.createElement("option");
        opt.value = String(l.level);
        opt.textContent = `第 ${l.level} 关 · ${l.count} 杯`;
        elLevelSelect.appendChild(opt);
      });
      elLevelSelect.addEventListener("change", ()=>{
        const lv = +elLevelSelect.value;
        setLevel(lv);
      });
    }

    btnNew.addEventListener("click", ()=> newPuzzle());
    btnReset.addEventListener("click", ()=> resetLevel());
    btnHint.addEventListener("click", ()=>{
      state.showHint = !state.showHint;
      btnHint.textContent = state.showHint ? "隐藏目标" : "显示目标";
      renderAll();
    });
    btnSound.addEventListener("click", ()=>{
      state.soundOn = !state.soundOn;
      btnSound.textContent = state.soundOn ? "开启" : "关闭";
    });

    /***********************
     *  Game logic
     ***********************/
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = (Math.random()*(i+1))|0;
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function setLevel(lv){
      const cfg = LEVELS.find(x=>x.level===lv) || LEVELS[0];
      state.level = cfg.level;
      state.count = cfg.count;
      newPuzzle();
    }

    function newPuzzle(){
      const pool = shuffle(COLORS).slice(0, state.count);
      state.target = pool.slice();        // correct mapping by index
      state.tray = shuffle(pool.slice()); // randomized candies
      state.placed = Array(9).fill(null);
      state.attempts = [];
      elStatusBig.textContent = "开始吧！";
      elStatusSub.textContent = "把下方色块拖到杯子里";
      renderAll();
    }

    function resetLevel(){
      // reset placements but keep same target + tray
      state.placed = Array(9).fill(null);
      state.attempts = [];
      elStatusBig.textContent = "重置完成";
      elStatusSub.textContent = "重新拖动色块";
      renderAll();
    }

    function isComplete(){
      for(let i=0;i<state.count;i++){
        if(state.placed[i] !== state.target[i]) return false;
      }
      return true;
    }

    function recordAttempt(){
      // record current placement snapshot
      const placedNow = state.placed.slice(0, state.count);
      const marks = placedNow.map((c,i)=> c === state.target[i]);
      const row = {
        placed: placedNow,
        marks,
        status: marks.every(Boolean) ? "ok" : "bad",
        stains: placedNow.slice(),
        burstDone: false,
        wrongGone: marks.map(ok => ok ? false : false),
      };
      state.attempts.push(row);
      elAttemptBadge.textContent = `尝试：${state.attempts.length}`;
      return row;
    }

    function checkIfAllPlaced(){
      const filled = state.placed.slice(0, state.count).every(x=>x);
      if(!filled) return;
      const row = recordAttempt();
      if(row.status === "ok"){
        sfxCorrect();
        elStatusBig.textContent = "成功！";
        elStatusSub.textContent = "你完成了本关";
        // flash latest row
        const last = elAttempts.firstElementChild;
        if(last) last.classList.add("flash");
      } else {
        sfxWrong();
        elStatusBig.textContent = "不对哦";
        elStatusSub.textContent = "错误位置会撤回，请再试一次";
        // remove wrong placements after a short moment
        setTimeout(()=>{
          row.marks.forEach((ok,i)=>{
            if(!ok){
              // return candy to tray
              const color = state.placed[i];
              state.placed[i] = null;
              if(color && !state.tray.includes(color)){
                state.tray.push(color);
              }
            }
          });
          renderAll();
        }, 240);
      }
      renderAll();
    }

    /***********************
     *  Drag & Touch
     ***********************/
    let ghost = null;
    let dragColor = null;

    function makeCandy(color){
      const el = document.createElement("div");
      el.className = "candy";
      el.style.background = `linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.06)), ${color}`;
      el.draggable = true;
      el.dataset.color = color;

      el.addEventListener("dragstart", (ev)=>{
        dragColor = color;
        ev.dataTransfer.setData("text/plain", color);
        ev.dataTransfer.effectAllowed = "move";
      });
      el.addEventListener("dragend", ()=>{
        dragColor = null;
      });

      // touch
      el.addEventListener("touchstart", (ev)=>{
        ev.preventDefault();
        dragColor = color;
        const t = ev.touches[0];
        showGhost(color, t.clientX, t.clientY);
      }, {passive:false});

      el.addEventListener("touchmove", (ev)=>{
        ev.preventDefault();
        const t = ev.touches[0];
        moveGhost(t.clientX, t.clientY);
      }, {passive:false});

      el.addEventListener("touchend", (ev)=>{
        ev.preventDefault();
        const t = (ev.changedTouches && ev.changedTouches[0]) || null;
        if(t){
          const targetEl = document.elementFromPoint(t.clientX, t.clientY);
          const cup = targetEl && targetEl.closest && targetEl.closest(".cup");
          if(cup){
            const idx = +cup.dataset.index;
            placeColor(idx, dragColor);
          }
        }
        hideGhost();
        dragColor = null;
      }, {passive:false});

      return el;
    }

    function showGhost(color, x, y){
      hideGhost();
      ghost = document.createElement("div");
      ghost.className = "dragGhost";
      ghost.style.background = `linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.06)), ${color}`;
      document.body.appendChild(ghost);
      moveGhost(x,y);
    }
    function moveGhost(x,y){
      if(!ghost) return;
      ghost.style.left = x + "px";
      ghost.style.top = y + "px";
    }
    function hideGhost(){
      if(ghost){
        ghost.remove();
        ghost = null;
      }
    }

    function placeColor(index, color){
      if(!color) return;
      if(index < 0 || index >= state.count) return;
      if(state.placed[index]) return; // already filled

      // remove from tray
      const pos = state.tray.indexOf(color);
      if(pos >= 0) state.tray.splice(pos,1);

      state.placed[index] = color;

      // quick sound feedback
      beep(520,0.03,"square",0.06);

      renderAll();
      checkIfAllPlaced();
    }

    /***********************
     *  Splat / Particles (used previously; now error visuals are disabled by renderAttempts)
     ***********************/
    function addSplat(cupEl, color){
      const s = document.createElement("div");
      s.className = "splat";
      s.style.background = color;
      const x = 10 + Math.random()*50;
      const y = 10 + Math.random()*45;
      s.style.left = x + "px";
      s.style.top = y + "px";
      cupEl.appendChild(s);
      setTimeout(()=>s.remove(), 600);
    }

    function spawnParticles(cupEl, color){
      for(let k=0;k<6;k++){
        const p = document.createElement("div");
        p.className = "particle";
        p.style.background = color;
        const x = 35 + (Math.random()*10-5);
        const y = 35 + (Math.random()*10-5);
        p.style.left = x + "px";
        p.style.top = y + "px";
        const dx = (Math.random()*80-40).toFixed(1) + "px";
        const dy = (Math.random()*-90-20).toFixed(1) + "px";
        p.style.setProperty("--dx", dx);
        p.style.setProperty("--dy", dy);
        p.style.setProperty("--delay", (Math.random()*0.06).toFixed(2)+"s");
        cupEl.appendChild(p);
        setTimeout(()=>p.remove(), 700);
      }
    }

    /***********************
     *  Render
     ***********************/
    function renderTray(){
      elTray.innerHTML = "";
      if(state.tray.length === 0){
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "托盘为空（色块都放入杯子里了）";
        elTray.appendChild(hint);
        return;
      }
      state.tray.forEach(c=>{
        elTray.appendChild(makeCandy(c));
      });
    }

    function makeCup(index){
      const cup = document.createElement("div");
      cup.className = "cup";
      cup.dataset.index = index;

      const target = document.createElement("div");
      target.className = "cupTarget";
      cup.appendChild(target);

      // show hint target color overlay
      if(state.showHint){
        target.style.borderStyle = "solid";
        target.style.borderColor = "rgba(255,255,255,.18)";
        target.style.background =
          `linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)), ${state.target[index]}`;
      } else {
        target.style.background = "rgba(0,0,0,.10)";
        target.style.borderStyle = "dashed";
        target.style.borderColor = "rgba(255,255,255,.20)";
      }

      // if placed
      const placedColor = state.placed[index];
      if(placedColor){
        const cc = document.createElement("div");
        cc.className = "cupCandy";
        cc.style.background = `linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.06)), ${placedColor}`;
        cup.appendChild(cc);
      }

      // drag drop
      cup.addEventListener("dragover", (ev)=>{
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
      });
      cup.addEventListener("drop", (ev)=>{
        ev.preventDefault();
        const color = ev.dataTransfer.getData("text/plain") || dragColor;
        placeColor(index, color);
      });

      return cup;
    }

    function renderAttempts(){
      elAttempts.innerHTML = "";
      // newest on top
      const list = state.attempts.slice().reverse();
      list.forEach((row, idx)=>{
        const card = document.createElement("div");
        card.className = "rowCard";

        const head = document.createElement("div");
        head.className = "rowHead";
        const label = document.createElement("div");
        label.className = "label";
        label.textContent = `第 ${state.attempts.length - idx} 次尝试`;
        const pill = document.createElement("div");
        pill.className = "pill " + (row.status === "ok" ? "ok" : "bad");
        pill.textContent = row.status === "ok" ? "正确" : "错误";
        head.appendChild(label);
        head.appendChild(pill);
        card.appendChild(head);

        const slots = document.createElement("div");
        slots.className = "slots";
        slots.dataset.count = String(state.count);

        for(let i=0;i<state.count;i++){
          const cup = document.createElement("div");
          cup.className = "cup";
          cup.dataset.index = i;

          const target = document.createElement("div");
          target.className = "cupTarget";
          cup.appendChild(target);

          // show placed snapshot
          const color = row.placed[i];
          if(color && !(row.status==="bad" && row.wrongGone && row.wrongGone[i]===true && row.marks[i]===false)){
            const cc = document.createElement("div");
            cc.className = "cupCandy";
            cc.style.background = `linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.06)), ${color}`;
            cup.appendChild(cc);
          }

          // mark ring
          if(row.marks[i]){
            cup.style.outline = "2px solid rgba(76,240,166,.55)";
            cup.style.outlineOffset = "2px";
          }else{
            cup.style.outline = "2px solid rgba(255,92,119,.45)";
            cup.style.outlineOffset = "2px";
          }

          slots.appendChild(cup);
        }

        card.appendChild(slots);
        elAttempts.appendChild(card);

        // 错误视觉：只糊化（无喷溅/粒子/缩小动画）
        if (row.status === "bad" && row.marks && row.burstDone === false){
          const cupEls = slots.querySelectorAll(".cup");
          const wrongIdxs = [];

          row.marks.forEach((ok, i) => {
            if (!ok){
              wrongIdxs.push(i);
              const candyEl = cupEls[i].querySelector(".cupCandy");
              if (candyEl) candyEl.classList.add("blurWrong");
            }
          });

          // 统一收尾：短延迟后移除错误糖果，只触发一次 render
          setTimeout(() => {
            if (!row.wrongGone) row.wrongGone = row.marks.map(() => false);
            wrongIdxs.forEach(i => row.wrongGone[i] = true);
            row.burstDone = true;
            renderAll();
          }, 160);
        }
      });

      // scroll to top (newest)
      elAttempts.scrollTop = 0;
    }

    function renderAll(){
      // update kpi
      elKLevel.textContent = String(state.level);
      elKCount.textContent = String(state.count);
      elLevelSelect.value = String(state.level);

      renderTray();
      renderAttempts();
    }

    /***********************
     *  Boot
     ***********************/
    initSelect();
    setLevel(1);
  </script>
</body>
</html>
