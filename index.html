<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æœæ±è½¯ç³– - æé€Ÿç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1330">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text:#e5e7eb;
      --panel:rgba(17,24,39,.75);
      --blue:rgba(59,130,246,.9);
      --red-glow: rgba(239, 68, 68, 0.4);
      
      /* åŸºç¡€å°ºå¯¸å˜é‡ */
      --cup-sz: 50px; 
      --candy-w: 86%;
      --candy-h: 68%;
    }

    body{
      margin:0;
      height:100vh;
      display:flex;
      justify-content:center;
      background: #0b1330; /* æ·±è“åº•è‰² */
      font-family: system-ui,-apple-system,sans-serif;
      color:var(--text);
      overflow:hidden;
      overscroll-behavior: none;
      /* ç®€å•çš„å¾„å‘èƒŒæ™¯ï¼Œå‡å°‘æ¸²æŸ“å‹åŠ› */
      background-image: 
        radial-gradient(circle at 50% 30%, #1e293b 0%, #0b1330 70%);
    }

    /* ===== æ ¸å¿ƒå®¹å™¨ï¼šå¼ºåˆ¶æ‰‹æœºæ¯”ä¾‹ ===== */
    .app-container {
      width: 100%;
      max-width: 420px; /* å…³é”®ï¼šé”å®šæœ€å¤§å®½åº¦ï¼Œæ¨¡ä»¿æ‰‹æœº */
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.2);
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }

    /* é¡¶éƒ¨æ  */
    header{
      padding: 12px 16px;
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      z-index: 10;
    }
    h1{ margin:0; font-size:16px; font-weight: 600; letter-spacing: 0.5px; }
    
    .status-bar{ display:flex; gap:12px; font-size:12px; color: #94a3b8; align-items: center; }
    .status-bar span { color: #f1f5f9; font-weight: bold; }

    /* æŒ‰é’®ç»„ */
    .controls {
        display: flex; gap: 8px; padding: 8px 16px;
        justify-content: flex-end;
    }
    .btn{
      background:rgba(51, 65, 85, 0.8);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.1);
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size: 12px;
      touch-action: manipulation;
    }
    .btn:active{ background: rgba(71, 85, 105, 1); transform: scale(0.96); }

    /* ===== æ¸¸æˆä¸»åŒºåŸŸ ===== */
    .game-area {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 10px;
        gap: 10px;
    }

    /* å°è¯•è®°å½•åŒº */
    .attempts-scroll {
        flex: 1;
        overflow-y: auto;
        border-radius: 12px;
        background: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.05);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
    }

    /* æ¯ä¸€è¡Œ */
    .row-card{
      display: flex;
      justify-content: center;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid transparent;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .row-card.active{
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .slots{
      display:grid;
      gap: 4px;
      grid-template-columns: repeat(var(--count), var(--cup-sz)); 
    }

    /* ===== æ¯å­ ===== */
    .cup{
      width: var(--cup-sz); 
      height: calc(var(--cup-sz) * 0.9);
      border-radius: 0 0 999px 999px; /* åŠåœ†æ¯åº• */
      border-top: none;
      position:relative; 
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: inset 0 -4px 6px rgba(0,0,0,0.2);
    }
    .cup.dropHover{
      background: rgba(59, 130, 246, 0.2);
      border-color: #60a5fa;
    }
    
    /* é”™è¯¯éœ‡åŠ¨åŠ¨ç”» */
    .cup.shake {
        animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        border-color: #f87171;
        background: rgba(239, 68, 68, 0.15);
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
      40%, 60% { transform: translate3d(3px, 0, 0); }
    }

    /* é”™è¯¯æ®‹ç•™æ ‡è®° */
    .residue-dot {
        position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
        width: 6px; height: 6px; border-radius: 50%;
        background: var(--c);
        box-shadow: 0 0 4px var(--c);
    }

    /* ===== ç³–æœ ===== */
    .candy{
      width: var(--candy-w); height: var(--candy-h);
      border-radius: 99px;
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 60%),
                  linear-gradient(135deg, var(--bg) 0%, rgba(0,0,0,0.2) 100%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 5;
      pointer-events: auto; /* å…è®¸äº¤äº’ */
    }
    /* è°ƒè‰²ç›˜é‡Œçš„ç³–æœ */
    .palette-candy {
        position: relative; transform: none; left: auto; top: auto;
        width: 100%; height: 100%;
    }
    .candy.used { opacity: 0.3; filter: grayscale(0.8); }

    /* ===== åº•éƒ¨è°ƒè‰²ç›˜ ===== */
    .palette-area {
      background: rgba(15, 23, 42, 0.8);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 10px 0 20px 0;
      flex-shrink: 0;
    }
    .palette-scroll {
      display:flex;
      gap: 8px;
      padding: 0 16px;
      overflow-x: auto;
      height: 50px;
      align-items: center;
    }
    .palette-scroll::-webkit-scrollbar{ display: none; } /* éšè—æ»šåŠ¨æ¡ */
    
    .p-item {
        width: 44px; height: 34px;
        flex-shrink: 0;
        display: flex; justify-content: center; align-items: center;
    }
    /* è°ƒè‰²ç›˜ç³–æœç¨å¾®å°ä¸€ç‚¹ */
    .p-item .candy { width: 40px; height: 30px; } 

    /* ===== æ‹–æ‹½å¹»å½± ===== */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      width: 50px; height: 36px;
      opacity: 0.9;
      transform: translate(-50%, -50%) scale(1.2);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }
  </style>
</head>

<body>
  <div class="app-container">
    <header>
        <h1>ğŸ¬ æœæ±è½¯ç³–</h1>
        <div class="status-bar">
            <div>å…³å¡ <span id="level">1</span></div>
            <div>æ•°é‡ <span id="pairs">3</span></div>
        </div>
    </header>
    
    <div class="controls">
        <button class="btn" id="soundBtn">ğŸ”‡</button>
        <button class="btn" id="resetBtn">â†º é‡ç½®</button>
        <button class="btn" id="wipeBtn" style="color:#fca5a5; border-color:rgba(239,68,68,0.3)">âš  æ¸…æ¡£</button>
    </div>

    <div class="game-area">
        <div class="attempts-scroll" id="attempts">
            </div>
    </div>

    <div class="palette-area">
        <div class="palette-scroll" id="palette">
            </div>
    </div>
  </div>

  <audio id="bg-soda" loop src="soda.mp3"></audio>
  <audio id="sfx-pop" src="pop.mp3"></audio>
  <audio id="sfx-correct" src="rightanswer-95129.mp3"></audio>

<script>
(() => {
  /* --- 1. é…ç½®ä¸çŠ¶æ€ --- */
  const COLORS = [
    "#ef4444", "#f97316", "#fde047", "#16a34a", "#22d3ee", "#1d4ed8", "#a855f7", 
    "#fb7185", "#5b341a", "#9ca3af", "#84cc16", "#4338ca", "#e11d48", "#14532d"
  ];
  
  const KEY_SAVE = 'gummy_v3_save';
  
  // æ¸¸æˆçŠ¶æ€
  let state = {
    level: 1,
    pairCount: 3,
    colors: [],     // æœ¬å…³ç”¨åˆ°çš„é¢œè‰²ç´¢å¼•
    answer: [],     // æ­£ç¡®ç­”æ¡ˆåºåˆ—
    rows: [],       // ç©å®¶çŒœæµ‹è®°å½•
    activeRow: 0,
    sound: false
  };

  /* --- 2. æ ¸å¿ƒé€»è¾‘ --- */
  
  function initGame() {
    // è¯»å–å­˜æ¡£
    const savedLvl = localStorage.getItem(KEY_SAVE);
    state.level = savedLvl ? parseInt(savedLvl) : 1;
    startLevel();
  }

  function getPairCount(lvl) {
    // 25å…³ä»¥åï¼š9-14ä¸ªéšæœº
    if (lvl > 25) return Math.floor(Math.random() * 6) + 9;
    // 25å…³ä»¥å‰ï¼šåŸæœ‰é€»è¾‘
    if (lvl === 1) return 3;
    const n = 4 + Math.floor((lvl - 2) / 3);
    return Math.min(n, 9);
  }

  function startLevel() {
    state.pairCount = getPairCount(state.level);
    
    // ç”Ÿæˆç­”æ¡ˆ
    const pool = COLORS.map((_, i) => i).sort(() => Math.random() - 0.5);
    state.colors = pool.slice(0, state.pairCount);
    state.answer = [...state.colors].sort(() => Math.random() - 0.5);
    
    // é‡ç½®è¡Œ
    state.rows = [{ guess: Array(state.pairCount).fill(null), status: 'active' }];
    state.activeRow = 0;

    renderUI();
    // é€‚é…å°ºå¯¸
    adjustSize();
  }

  function handleGuess(rowIdx, slotIdx, colorId) {
    const row = state.rows[rowIdx];
    if (row.status !== 'active') return;

    // å¦‚æœè¯¥é¢œè‰²å·²åœ¨åˆ«å¤„ï¼Œå…ˆç§»é™¤
    const existIdx = row.guess.indexOf(colorId);
    if (existIdx !== -1 && existIdx !== slotIdx) row.guess[existIdx] = null;
    
    row.guess[slotIdx] = colorId;
    renderBoard(); // å±€éƒ¨åˆ·æ–°

    // æ£€æŸ¥è¡Œæ˜¯å¦å¡«æ»¡
    if (row.guess.every(c => c !== null)) {
        checkRow(row);
    }
  }

  function checkRow(row) {
    const isCorrect = row.guess.every((c, i) => c === state.answer[i]);
    
    if (isCorrect) {
        row.status = 'win';
        playSound('correct');
        renderBoard();
        setTimeout(() => {
            state.level++;
            localStorage.setItem(KEY_SAVE, state.level);
            startLevel();
        }, 800);
    } else {
        row.status = 'bad'; // è§¦å‘éœ‡åŠ¨åŠ¨ç”»
        playSound('pop');
        renderBoard();
        
        // æé€Ÿæ¢å¤ï¼š500msåè¿›å…¥ä¸‹ä¸€è¡Œ
        setTimeout(() => {
            state.rows.push({ guess: Array(state.pairCount).fill(null), status: 'active' });
            state.activeRow++;
            renderBoard();
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const el = document.getElementById('attempts');
            el.scrollTop = el.scrollHeight;
        }, 500);
    }
  }

  /* --- 3. æ¸²æŸ“ç³»ç»Ÿ (Render) --- */

  function adjustSize() {
    // å¼ºåˆ¶é€‚é…ï¼šæ ¹æ®å±å¹•å®½åº¦çš„é™åˆ¶æ¥è®¡ç®—
    // å®¹å™¨æœ€å¤§ 420pxï¼Œå·¦å³paddingå…±20pxï¼Œé—´éš™4px
    const containerW = Math.min(window.innerWidth, 420); 
    const usableW = containerW - 24; 
    let sz = (usableW - (state.pairCount - 1) * 4) / state.pairCount;
    
    // é™åˆ¶å¤§å°èŒƒå›´
    sz = Math.max(28, Math.min(50, sz));
    
    document.documentElement.style.setProperty('--cup-sz', sz + 'px');
    document.documentElement.style.setProperty('--count', state.pairCount);
  }

  function renderUI() {
    document.getElementById('level').innerText = state.level;
    document.getElementById('pairs').innerText = state.pairCount;
    renderPalette();
    renderBoard();
  }

  function renderPalette() {
    const p = document.getElementById('palette');
    p.innerHTML = '';
    
    // æ‰¾å‡ºå·²ä½¿ç”¨çš„é¢œè‰²ï¼ˆç½®ç°ï¼‰
    const activeRow = state.rows[state.activeRow];
    const used = new Set(activeRow ? activeRow.guess : []);

    state.colors.forEach(cid => {
        const wrap = document.createElement('div');
        wrap.className = 'p-item';
        
        const c = document.createElement('div');
        c.className = 'candy palette-candy';
        c.style.setProperty('--bg', COLORS[cid]);
        if (used.has(cid)) c.classList.add('used');
        
        // è§¦æ‘¸äº‹ä»¶ç»‘å®š
        c.addEventListener('touchstart', (e) => handleTouchStart(e, c, cid), {passive: false});
        // PCé¼ æ ‡äº‹ä»¶
        c.onmousedown = (e) => {
            // ç®€å•çš„PCå…¼å®¹ï¼Œä¸ä½œä¸ºé‡ç‚¹
            handleTouchStart({
                preventDefault:()=>{}, 
                changedTouches:[{identifier:99, clientX:e.clientX, clientY:e.clientY}],
                touches: []
            }, c, cid);
        };
        
        wrap.appendChild(c);
        p.appendChild(wrap);
    });
  }

  function renderBoard() {
    const board = document.getElementById('attempts');
    board.innerHTML = '';

    state.rows.forEach((row, rIdx) => {
        const card = document.createElement('div');
        card.className = 'row-card' + (rIdx === state.activeRow ? ' active' : '');
        
        const slots = document.createElement('div');
        slots.className = 'slots';
        
        row.guess.forEach((cid, sIdx) => {
            const cup = document.createElement('div');
            cup.className = 'cup';
            cup.dataset.r = rIdx;
            cup.dataset.s = sIdx;

            // é”™è¯¯çŠ¶æ€ï¼šéœ‡åŠ¨ + å˜çº¢
            if (row.status === 'bad') {
                const isWrong = (cid !== state.answer[sIdx]);
                if (isWrong) {
                    cup.classList.add('shake');
                    // ç•™ä¸‹ä¸€ä¸ªå°ç‚¹æ ‡è®°
                    const dot = document.createElement('div');
                    dot.className = 'residue-dot';
                    dot.style.setProperty('--c', COLORS[cid]);
                    cup.appendChild(dot);
                }
            }

            // æ”¾å…¥ç³–æœ
            if (cid !== null && !(row.status === 'bad' && cid !== state.answer[sIdx])) {
                 const c = document.createElement('div');
                 c.className = 'candy';
                 c.style.setProperty('--bg', COLORS[cid]);
                 cup.appendChild(c);
            }
            
            slots.appendChild(cup);
        });
        
        card.appendChild(slots);
        board.appendChild(card);
    });
  }

  /* --- 4. äº¤äº’ç³»ç»Ÿ (Touch) --- */
  let ghost = null;
  let dragId = null;
  let activeColor = null;
  let hoverCup = null;

  function handleTouchStart(e, el, cid) {
    e.preventDefault();
    const t = e.changedTouches[0] || e; // å…¼å®¹é¼ æ ‡ä¼ªé€ çš„touch
    dragId = t.identifier;
    activeColor = cid;

    // åˆ›å»ºå¹»å½±
    ghost = el.cloneNode(true);
    ghost.className = 'candy drag-ghost';
    ghost.style.setProperty('--bg', COLORS[cid]);
    ghost.style.left = t.clientX + 'px';
    ghost.style.top = t.clientY + 'px';
    document.body.appendChild(ghost);
  }

  document.addEventListener('touchmove', (e) => {
    if (!ghost) return;
    const t = Array.from(e.changedTouches).find(x => x.identifier === dragId);
    if (!t) return;
    e.preventDefault();

    ghost.style.left = t.clientX + 'px';
    ghost.style.top = t.clientY + 'px';

    // æ£€æµ‹æ¯å­
    const elUnder = document.elementFromPoint(t.clientX, t.clientY);
    const cup = elUnder ? elUnder.closest('.cup') : null;
    
    // åªå…è®¸æ‹–å…¥å½“å‰è¡Œçš„æ¯å­
    if (cup && parseInt(cup.dataset.r) === state.activeRow) {
        if (hoverCup !== cup) {
            if (hoverCup) hoverCup.classList.remove('dropHover');
            cup.classList.add('dropHover');
            hoverCup = cup;
        }
    } else if (hoverCup) {
        hoverCup.classList.remove('dropHover');
        hoverCup = null;
    }
  }, {passive: false});
  
  // å…¼å®¹PCé¼ æ ‡ç§»åŠ¨
  document.addEventListener('mousemove', (e) => {
      if (dragId === 99) { // æ¨¡æ‹ŸID
         const fakeEvent = {
             changedTouches: [{identifier: 99, clientX: e.clientX, clientY: e.clientY}],
             preventDefault: ()=>{}
         };
         // å¤ç”¨ touchmove é€»è¾‘ï¼ˆç•¥ä½œç®€åŒ–è°ƒç”¨ï¼‰
         const t = fakeEvent.changedTouches[0];
         ghost.style.left = t.clientX + 'px';
         ghost.style.top = t.clientY + 'px';
         const elUnder = document.elementFromPoint(t.clientX, t.clientY);
         const cup = elUnder ? elUnder.closest('.cup') : null;
         if (cup && parseInt(cup.dataset.r) === state.activeRow) {
            if (hoverCup !== cup) {
                if(hoverCup) hoverCup.classList.remove('dropHover');
                cup.classList.add('dropHover');
                hoverCup = cup;
            }
         } else if(hoverCup) {
             hoverCup.classList.remove('dropHover');
             hoverCup = null;
         }
      }
  });

  const endDrag = (e) => {
    if (!ghost) return;
    // é¼ æ ‡å…¼å®¹
    let t = null;
    if (e.type === 'mouseup') t = {identifier: 99};
    else t = Array.from(e.changedTouches).find(x => x.identifier === dragId);
    
    if (!t) return;

    ghost.remove();
    ghost = null;
    dragId = null;

    if (hoverCup) {
        hoverCup.classList.remove('dropHover');
        handleGuess(parseInt(hoverCup.dataset.r), parseInt(hoverCup.dataset.s), activeColor);
        hoverCup = null;
    }
  };

  document.addEventListener('touchend', endDrag);
  document.addEventListener('mouseup', endDrag);

  /* --- 5. éŸ³é¢‘ä¸å·¥å…· --- */
  const audios = {
    bg: document.getElementById('bg-soda'),
    pop: document.getElementById('sfx-pop'),
    correct: document.getElementById('sfx-correct')
  };
  // é¢„è®¾ç½®éŸ³é‡
  audios.bg.volume = 0.3;

  function playSound(key) {
    if (!state.sound) return;
    const a = audios[key];
    if (a) {
        a.currentTime = 0;
        a.play().catch(e => console.log('Audio blocked', e));
    }
  }

  document.getElementById('soundBtn').onclick = function() {
    state.sound = !state.sound;
    this.innerText = state.sound ? 'ğŸ”Š' : 'ğŸ”‡';
    if (state.sound) {
        audios.bg.play().catch(()=>{});
    } else {
        audios.bg.pause();
    }
  };

  document.getElementById('resetBtn').onclick = () => {
     startLevel(); // é‡ç©æœ¬å…³
  };
  document.getElementById('wipeBtn').onclick = () => {
     if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¿›åº¦ä»ç¬¬1å…³å¼€å§‹å—ï¼Ÿ')) {
         localStorage.removeItem(KEY_SAVE);
         state.level = 1;
         startLevel();
     }
  };
  
  window.addEventListener('resize', adjustSize);

  // å¯åŠ¨
  initGame();
  
  // SW
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => { navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
  }

})();
</script>
</body>
</html>
