<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#0b1b2a" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="./manifest.webmanifest" />

  <title>æœæ±è½¯ç³–é…å¯¹</title>

  <style>
    :root{
      --bg1:#07131f;
      --bg2:#0b2438;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:rgba(120,200,255,.25);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 50% -20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 700px at 30% 30%, rgba(90,140,255,.10), transparent 55%),
        radial-gradient(900px 700px at 80% 55%, rgba(0,255,200,.06), transparent 60%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial;
      overflow:hidden;              /* å…³é”®ï¼šä¸è®©é¡µé¢æ»šåŠ¨ */
      touch-action:none;            /* å…³é”®ï¼šç¦ç”¨æµè§ˆå™¨é»˜è®¤è§¦æ‘¸æ‰‹åŠ¿ */
      -webkit-user-select:none;
      user-select:none;
    }

    /* èƒŒæ™¯æ³¡æ³¡ */
    .bg-bubbles{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      overflow:hidden;
      z-index:0;
    }
    .bubble{
      position:absolute;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,.03) 60%, transparent 72%);
      border-radius:999px;
      filter: blur(.2px);
      animation: float 18s linear infinite;
    }
    @keyframes float{
      0%{ transform: translateY(110vh) scale(.85); opacity:0; }
      10%{ opacity:.6; }
      80%{ opacity:.45; }
      100%{ transform: translateY(-20vh) scale(1.1); opacity:0; }
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width: 980px;
      margin: 0 auto;
      padding: clamp(14px, 2.2vw, 20px);
      padding-top: calc(env(safe-area-inset-top) + clamp(12px, 2vw, 18px));
      padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size:12px;
      color:var(--muted);
    }
    .meta > div{
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .btn:active{ transform: translateY(1px); }

    .panel{
      flex:1;
      min-height:0;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(14px);
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }

    .hint{
      display:flex;
      justify-content:space-between;
      color:rgba(255,255,255,.50);
      font-size:12px;
      padding: 0 6px;
    }

    .attemptArea{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 6px;
      border-radius: 18px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.06);
    }

    .attempts{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px;
    }

    .rowCard{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .rowCard.active{
      outline: 2px solid rgba(120,200,255,.18);
      box-shadow: 0 0 0 6px rgba(120,200,255,.06);
    }

    .slots{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* ====== ç»ç’ƒæ¯ï¼ˆdrop targetï¼‰ ====== */
    .cup{
      width: 74px;
      height: 56px;
      border-radius: 16px;
      position:relative;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03) 40%, rgba(255,255,255,.02)),
        radial-gradient(50px 30px at 30% 25%, rgba(255,255,255,.16), transparent 60%);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
      overflow:hidden;
    }
    .cup::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(30px 50px at 18% 50%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(70px 40px at 70% 20%, rgba(255,255,255,.10), transparent 62%);
      opacity:.8;
      pointer-events:none;
    }
    .cup::after{
      content:"";
      position:absolute;
      left:10px; top:6px;
      width:12px; height:70%;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.24), transparent);
      opacity:.65;
      filter: blur(.2px);
      pointer-events:none;
    }

    .dropHover{
      outline: 2px solid rgba(120,200,255,.35);
      box-shadow: 0 0 0 6px rgba(120,200,255,.10);
    }

    /* æ¯å­é‡Œçš„â€œæ®‹ç•™â€æœå†» */
    .residue{
      position:absolute;
      left:10%;
      right:10%;
      bottom:10%;
      height:58%;
      border-radius: 14px;
      background:
        radial-gradient(18px 12px at 25% 30%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(22px 16px at 70% 55%, rgba(255,255,255,.25), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.06)),
        var(--residue, rgba(255,255,255,.18));
      opacity:.92;
      filter: saturate(1.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 10px 18px rgba(255,255,255,.10);
    }

    /* ====== Palette å¡ç‰‡ ====== */
    .paletteCard{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .paletteRow{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .palette{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }

    .paletteTip{
      font-size:12px;
      color:rgba(255,255,255,.50);
    }

    /* ================= æœå†»ç³–ï¼ˆæ ¸å¿ƒè´¨æ„Ÿï¼‰ ================= */
    .candy{
      width: 76px;
      height: 56px;
      border-radius: 18px;
      position:relative;
      cursor: grab;
      transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
    }
    .paletteCandy{ cursor: grab; }
    .cupCandy{ cursor: default; }

    .candy{
      background:
        radial-gradient(20px 16px at 26% 28%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(30px 24px at 70% 68%, rgba(255,255,255,.20), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.05)),
        linear-gradient(135deg, color-mix(in srgb, var(--candy-fill) 92%, white 8%), color-mix(in srgb, var(--candy-fill) 92%, black 8%));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.16),
        inset 0 -10px 18px rgba(0,0,0,.12),
        0 10px 28px rgba(0,0,0,.30);
      filter: saturate(1.15);
    }
    .candy::before{
      content:"";
      position:absolute;
      left:12px; top:10px;
      width:14px; height:60%;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.30), transparent);
      opacity:.7;
      filter: blur(.2px);
      pointer-events:none;
    }
    .candy::after{
      content:"";
      position:absolute;
      right:10px; top:10px;
      width:22px; height:22px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,.12) 45%, transparent 70%);
      opacity:.8;
      pointer-events:none;
    }

    /* æ‰‹æŒ‡æ‹–åŠ¨æ—¶ï¼Œç³–æœè·Ÿéšç”¨çš„â€œæµ®èµ·æ„Ÿâ€ */
    .dragGhost{
      position: fixed;
      z-index: 9999;
      pointer-events:none;
      transform: translate(-50%, -50%);
      opacity: .95;
    }

    /* pop å°åŠ¨ç”» */
    .pop{
      animation: pop .18s ease-out;
    }
    @keyframes pop{
      0%{ transform: scale(.92); }
      100%{ transform: scale(1); }
    }

    /* iPhone å°å±é€‚é… */
    @media (max-width: 520px){
      .cup{ width: 64px; height: 50px; border-radius: 15px; }
      .candy{ width: 66px; height: 50px; border-radius: 16px; }
      .rowCard{ padding: 10px; }
      .slots{ gap:10px; }
    }

    /* ç¾åŒ–æ»šåŠ¨æ¡ï¼ˆæ¡Œé¢ï¼‰ */
    .attemptArea::-webkit-scrollbar{ width:10px; }
    .attemptArea::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.08);
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <!-- éŸ³é¢‘ï¼šæ–‡ä»¶åä¿æŒ soda.mp3 / pop.mp3 / correct.mp3 -->
  <audio id="bg-soda" preload="auto" loop src="soda.mp3"></audio>
  <audio id="sfx-pop" preload="auto" src="pop.mp3"></audio>
  <audio id="sfx-correct" preload="auto" src="correct.mp3"></audio>

  <div class="wrap">
    <header>
      <h1>ğŸ§ƒğŸ¬ æœæ±è½¯ç³–é…å¯¹</h1>

      <div class="meta">
        <div>å…³å¡ï¼š<span id="level">1</span></div>
        <div>é…å¯¹ï¼š<span id="pairs">3</span></div>
        <div>å°è¯•ï¼š<span id="tries">0</span></div>
        <button class="btn" id="soundBtn">ğŸ”‡ å£°éŸ³å·²å…³é—­</button>
        <button class="btn" id="resetLevel">é‡ç½®æœ¬å…³</button>
        <button class="btn" id="restart">ä»ç¬¬1å…³é‡å¼€</button>
      </div>
    </header>

    <div class="panel">
      <div class="hint">
        <div>ç›®æ ‡é…æ–¹ï¼ˆä¸Šï¼‰ / ä½ çš„æ¯å­ï¼ˆä¸‹ï¼‰</div>
        <div>æ‹–åŠ¨ç³–æœåˆ°æ¯å­ï¼Œæˆ–ç‚¹å‡»ç³–æœå†ç‚¹æ¯å­</div>
      </div>

      <div class="attemptArea">
        <div class="attempts" id="attempts"></div>
      </div>

      <div class="paletteCard">
        <div class="paletteRow">
          <div class="paletteTip">ç³–æœæ± ï¼ˆæ‰‹æŒ‡æ‹–åŠ¨åˆ°æ¯å­ï¼‰</div>
          <div class="paletteTip">æœ€å¤š 9 ç§é¢œè‰²ï¼Œè‡ªåŠ¨å‹ç¼©å¸ƒå±€</div>
        </div>
        <div class="palette" id="palette"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ================== åŸºç¡€æ•°æ® ==================
  const COLOR_POOL = [
    { name:"Blue",   hex:"#6ad2ff" },
    { name:"Red",    hex:"#ff5d6e" },
    { name:"Yellow", hex:"#ffd35a" },
    { name:"Green",  hex:"#62e38e" },
    { name:"Orange", hex:"#ffb15a" },
    { name:"Purple", hex:"#b38aff" },
    { name:"Pink",   hex:"#ff7fc4" },
    { name:"Teal",   hex:"#2ee6d6" },
    { name:"Lime",   hex:"#c9ff57" },
  ];

  const elAttempts = document.getElementById("attempts");
  const elPalette  = document.getElementById("palette");

  const elLevel = document.getElementById("level");
  const elPairs = document.getElementById("pairs");
  const elTries = document.getElementById("tries");

  const btnSound = document.getElementById("soundBtn");
  const btnReset = document.getElementById("resetLevel");
  const btnRestart = document.getElementById("restart");

  const bgSoda = document.getElementById("bg-soda");
  const sfxPop = document.getElementById("sfx-pop");
  const sfxCorrect = document.getElementById("sfx-correct");

  let soundOn = false;

  // å…³å¡å‚æ•°ï¼ˆä½ å¯æ”¹ï¼‰
  let level = 1;
  let pairCount = 3;

  // æ¸¸æˆçŠ¶æ€
  let correctSeq = [];
  let attempts = []; // æ¯è¡Œï¼š{ status, guess[], residue[] }
  let activeRowIndex = 0;

  // æ‹–æ‹½çŠ¶æ€ï¼ˆPCæ‹–æ‹½ + iPhoneè§¦æ‘¸ï¼‰
  let draggingColorId = null;
  let draggingTouch = null; // { x,y, el, ghostEl }
  let lastHoverCup = null;

  // ================== èƒŒæ™¯æ³¡æ³¡ ==================
  function spawnBubbles(){
    const host = document.getElementById("bgBubbles");
    host.innerHTML = "";
    const n = 18;
    for(let i=0;i<n;i++){
      const b = document.createElement("div");
      b.className = "bubble";
      const size = 18 + Math.random()*60;
      b.style.width = size+"px";
      b.style.height = size+"px";
      b.style.left = (Math.random()*100)+"%";
      b.style.animationDuration = (14 + Math.random()*18)+"s";
      b.style.animationDelay = (-Math.random()*18)+"s";
      host.appendChild(b);
    }
  }

  // ================== å·¥å…·å‡½æ•° ==================
  function randInt(n){ return Math.floor(Math.random()*n); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function playPop(){
    if(!soundOn) return;
    sfxPop.currentTime = 0;
    sfxPop.play().catch(()=>{});
  }
  function playCorrect(){
    if(!soundOn) return;
    sfxCorrect.currentTime = 0;
    sfxCorrect.play().catch(()=>{});
  }

  function setSound(on){
    soundOn = on;
    btnSound.textContent = on ? "ğŸ”Š å£°éŸ³å·²å¼€å¯" : "ğŸ”‡ å£°éŸ³å·²å…³é—­";
    if(on){
      bgSoda.volume = 0.35;
      bgSoda.play().catch(()=>{});
    }else{
      bgSoda.pause();
      bgSoda.currentTime = 0;
    }
  }

  // ================== ç”Ÿæˆç³–æœ DOM ==================
  function makeCandyDiv(colorId, { inCup=false } = {}){
    const c = COLOR_POOL[colorId];
    const d = document.createElement("div");
    d.className = "candy";
    d.dataset.colorId = String(colorId);

    // âœ… å…³é”®ï¼šç”¨ CSS å˜é‡æ§åˆ¶é¢œè‰²ï¼ˆä¸è¦å†å†™ d.style.backgroundï¼‰
    d.style.setProperty("--candy-fill", c.hex);

    if(inCup){
      d.classList.add("cupCandy");
      d.draggable = false;
    }else{
      d.classList.add("paletteCandy");
      d.draggable = true;

      // PCï¼šHTML5 drag
      d.addEventListener("dragstart", (e) => {
        draggingColorId = colorId;
        e.dataTransfer.setData("text/plain", String(colorId));
        e.dataTransfer.effectAllowed = "move";
      });
      d.addEventListener("dragend", () => draggingColorId = null);

      // iPhoneï¼štouchstartï¼ˆæ‹¿èµ·ç³–æœï¼‰
      d.addEventListener("touchstart", (e) => {
        e.preventDefault();

        draggingColorId = colorId;

        const t = e.touches[0];
        const ghost = d.cloneNode(true);
        ghost.classList.add("dragGhost");
        document.body.appendChild(ghost);

        draggingTouch = {
          x: t.clientX,
          y: t.clientY,
          el: d,
          ghostEl: ghost,
        };
        positionGhost(t.clientX, t.clientY);
        playPop();
      }, { passive:false });

      // å…¼å®¹ï¼šç‚¹å‡»ç³–æœåå†ç‚¹æ¯å­
      d.addEventListener("click", () => {
        draggingColorId = colorId;
        playPop();
      });
    }

    return d;
  }

  function positionGhost(x,y){
    if(!draggingTouch?.ghostEl) return;
    draggingTouch.ghostEl.style.left = x + "px";
    draggingTouch.ghostEl.style.top  = y + "px";
  }

  function clearHover(){
    if(lastHoverCup){
      lastHoverCup.classList.remove("dropHover");
      lastHoverCup = null;
    }
  }

  function findCupUnderPoint(x,y){
    const el = document.elementFromPoint(x,y);
    if(!el) return null;
    return el.classList?.contains("cup") ? el : el.closest?.(".cup");
  }

  // ================== ç”Ÿæˆä¸€è¡Œï¼ˆç›®æ ‡è¡Œ & ç©å®¶è¡Œï¼‰ ==================
  function newRow(status){
    return {
      status,                 // "target" | "active" | "done"
      guess: Array(pairCount).fill(null),
      residue: Array(pairCount).fill(null),
    };
  }

  function buildTarget(){
    correctSeq = [];
    for(let i=0;i<pairCount;i++){
      correctSeq.push(randInt(Math.min(6 + level, COLOR_POOL.length)));
    }
  }

  function setupLevel(){
    elLevel.textContent = String(level);
    elPairs.textContent = String(pairCount);
    elTries.textContent = "0";

    buildTarget();
    attempts = [ newRow("target"), newRow("active") ];
    activeRowIndex = 1;

    renderAll();
  }

  // ================== æ¸²æŸ“ ==================
  function renderPalette(){
    elPalette.innerHTML = "";
    const useCount = clamp(6 + level, 3, COLOR_POOL.length);
    for(let i=0;i<useCount;i++){
      elPalette.appendChild(makeCandyDiv(i));
    }
  }

  function renderAttempts(){
    elAttempts.innerHTML = "";

    attempts.forEach((row, idx) => {
      const card = document.createElement("div");
      card.className = "rowCard" + (idx === activeRowIndex ? " active" : "");

      const slots = document.createElement("div");
      slots.className = "slots";
      slots.dataset.count = String(pairCount);

      for(let s=0;s<pairCount;s++){
        const cup = document.createElement("div");
        cup.className = "cup";
        cup.dataset.row = String(idx);
        cup.dataset.slot = String(s);

        // ç›®æ ‡è¡Œï¼šå±•ç¤ºæ­£ç¡®é…æ–¹ï¼ˆä¸Šæ’ï¼‰
        if(row.status === "target"){
          const candy = makeCandyDiv(correctSeq[s], { inCup:true });
          candy.classList.add("pop");
          cup.appendChild(candy);
        } else {
          // ç©å®¶è¡Œï¼šå±•ç¤ºæ®‹ç•™ + å·²æ”¾å…¥ç³–æœ
          if(row.residue[s]){
            const r = document.createElement("div");
            r.className = "residue";
            r.style.setProperty("--residue", row.residue[s]);
            cup.appendChild(r);
          }
          if(row.guess[s] !== null){
            const candy = makeCandyDiv(row.guess[s], { inCup:true });
            cup.appendChild(candy);
          }

          if(row.status === "active"){
            // PCï¼šdragover/drop
            cup.addEventListener("dragover", (e) => {
              e.preventDefault();
              cup.classList.add("dropHover");
            });
            cup.addEventListener("dragleave", () => cup.classList.remove("dropHover"));
            cup.addEventListener("drop", (e) => {
              e.preventDefault();
              cup.classList.remove("dropHover");
              const data = e.dataTransfer.getData("text/plain");
              const colorId = data ? Number(data) : draggingColorId;
              if(Number.isFinite(colorId)){
                placeColor(idx, s, colorId);
              }
            });

            // iPhoneï¼šç‚¹å‡»æ¯å­æ”¾å…¥ï¼ˆé…åˆâ€œç‚¹ç³–æœå†ç‚¹æ¯å­â€ï¼‰
            cup.addEventListener("click", () => {
              if(draggingColorId === null) return;
              placeColor(idx, s, draggingColorId);
              draggingColorId = null;
            });
          }
        }

        slots.appendChild(cup);
      }

      card.appendChild(slots);
      elAttempts.appendChild(card);
    });

    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•ï¼ˆç§»åŠ¨ç«¯ä¹Ÿèˆ’æœï¼‰
    elAttempts.parentElement.scrollTop = elAttempts.parentElement.scrollHeight;
  }

  function renderAll(){
    elLevel.textContent = String(level);
    elPairs.textContent = String(pairCount);
    elTries.textContent = String(attempts.filter(r => r.status === "done").length);

    renderPalette();
    renderAttempts();
  }

  // ================== æ”¾ç½®ç³–æœé€»è¾‘ ==================
  function placeColor(rowIdx, slotIdx, colorId){
    const row = attempts[rowIdx];
    if(row.status !== "active") return;

    row.guess[slotIdx] = colorId;
    row.residue[slotIdx] = `linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.04)), ${COLOR_POOL[colorId].hex}`;

    playPop();
    renderAttempts();

    // è‡ªåŠ¨æ£€æŸ¥ï¼šå¡«æ»¡ååˆ¤æ–­æ˜¯å¦å…¨å¯¹
    if(row.guess.every(v => v !== null)){
      const allCorrect = row.guess.every((v,i) => v === correctSeq[i]);
      row.status = "done";

      if(allCorrect){
        playCorrect();
        // ä¸‹ä¸€å…³
        level += 1;
        pairCount = clamp(3 + Math.floor(level/2), 3, 6);
        setTimeout(setupLevel, 550);
      } else {
        // å¼€æ–°ä¸€è¡Œç»§ç»­
        attempts.push(newRow("active"));
        activeRowIndex = attempts.length - 1;
      }
      renderAll();
    }
  }

  // ================== å…¨å±€è§¦æ‘¸æ‹–æ‹½ï¼ˆiPhoneå…³é”®ï¼‰ ==================
  window.addEventListener("touchmove", (e) => {
    if(!draggingTouch) return;
    e.preventDefault();

    const t = e.touches[0];
    positionGhost(t.clientX, t.clientY);

    const cup = findCupUnderPoint(t.clientX, t.clientY);
    if(cup !== lastHoverCup){
      clearHover();
      if(cup){
        cup.classList.add("dropHover");
        lastHoverCup = cup;
      }
    }
  }, { passive:false });

  window.addEventListener("touchend", (e) => {
    if(!draggingTouch) return;
    e.preventDefault();

    const t = e.changedTouches[0];
    const cup = findCupUnderPoint(t.clientX, t.clientY);

    if(draggingTouch.ghostEl){
      draggingTouch.ghostEl.remove();
    }

    clearHover();

    if(cup && draggingColorId !== null){
      const rowIdx = Number(cup.dataset.row);
      const slotIdx = Number(cup.dataset.slot);
      if(Number.isFinite(rowIdx) && Number.isFinite(slotIdx)){
        placeColor(rowIdx, slotIdx, draggingColorId);
      }
    }

    draggingTouch = null;
    draggingColorId = null;
  }, { passive:false });

  // ================== æŒ‰é’® ==================
  btnSound.addEventListener("click", () => setSound(!soundOn));
  btnReset.addEventListener("click", () => setupLevel());
  btnRestart.addEventListener("click", () => {
    level = 1;
    pairCount = 3;
    setupLevel();
  });

  // ================== iOSï¼šå‡å°‘åº•éƒ¨æ å¹²æ‰°çš„å°æŠ€å·§ ==================
  window.addEventListener("load", () => {
    // iOS Safari å¸¸ç”¨å°æŠ€å·§ï¼šå‘ä¸‹æ»šåŠ¨ 1px è®©åœ°å€æ æ›´å®¹æ˜“æ”¶èµ·ï¼ˆä¸ä¿è¯æ¯å°æœºéƒ½100%ï¼‰
    setTimeout(() => window.scrollTo(0, 1), 50);
  });

  // ================== SW ==================
  if("serviceWorker" in navigator){
    window.addEventListener("load", async () => {
      try{
        await navigator.serviceWorker.register("./sw.js", { scope: "./" });
      }catch(e){}
    });
  }

  // init
  spawnBubbles();
  setupLevel();
})();
</script>
</body>
</html>
