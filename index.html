<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æœæ±è½¯ç³– - è´¨æ„Ÿå›å½’ç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1330">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text:#e5e7eb;
      --panel:rgba(17,24,39,.65);
      --blue:rgba(59,130,246,.95);
      
      /* åŠ¨æ€å˜é‡ï¼šé»˜è®¤å€¼ */
      --cup-sz: 50px; 
      --candy-w: 86%; 
      --candy-h: 68%; 
    }

    body{
      margin:0;
      height:100vh;
      display:flex;
      justify-content:center;
      font-family: system-ui,-apple-system,sans-serif;
      color:var(--text);
      overflow:hidden;
      overscroll-behavior: none;
      
      /* ===== å›å½’ï¼šé«˜çº§èƒŒæ™¯ ===== */
      background:
        radial-gradient(900px 520px at 35% 10%, rgba(255,255,255,.16), transparent 55%),
        radial-gradient(820px 520px at 75% 15%, rgba(255,255,255,.10), transparent 58%),
        linear-gradient(180deg,#0b1330 0%,#0b2a3a 40%,#0a3a4a 70%,#0a2b43 100%);
    }

    /* ===== èƒŒæ™¯æ³¡æ³¡ ===== */
    .bg-bubbles{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
    .bubble{
      position:absolute; bottom:-60px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), transparent 60%);
      border:1px solid rgba(255,255,255,.15);
      opacity:.4;
      animation: rise var(--dur) linear infinite, sway var(--sway) ease-in-out infinite;
      left: var(--x); width: var(--size); height: var(--size);
      animation-delay: var(--delay);
    }
    @keyframes rise{ from{ transform: translateY(0); } to{ transform: translateY(-110vh); } }
    @keyframes sway{ 0%,100%{ margin-left:0; } 50%{ margin-left:var(--sx); } }

    /* ===== App å®¹å™¨ ===== */
    .app-container {
      width: 100%;
      max-width: 440px; /* é™åˆ¶æ‰‹æœºå®½åº¦ */
      height: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      z-index: 1;
      background: rgba(0,0,0,0.1);
      backdrop-filter: blur(2px);
    }

    header{
      padding: 10px 16px;
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(15, 23, 42, 0.4);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }
    h1{ margin:0; font-size:16px; font-weight: 600; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .status-bar{ font-size:12px; color: #cbd5e1; display:flex; gap:10px; }
    .status-bar span { font-weight:bold; color:#fff; }

    .controls { display: flex; gap: 8px; padding: 8px 16px; justify-content: flex-end; }
    .btn{
      background:rgba(30, 41, 59, 0.7);
      color:var(--text); border:1px solid rgba(255,255,255,0.15);
      padding:6px 12px; border-radius:8px; font-size: 12px; cursor: pointer;
    }
    .btn:active{ transform:scale(0.96); background:rgba(255,255,255,0.1); }

    .game-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }
    .attempts-scroll {
        flex: 1; overflow-y: auto;
        padding: 10px 4px;
        display: flex; flex-direction: column; gap: 12px;
        scroll-behavior: smooth;
    }
    .attempts-scroll::-webkit-scrollbar{ width:4px; }
    .attempts-scroll::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.2); border-radius:4px; }

    /* è¡Œ */
    .row-card{
      display: flex; justify-content: center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .row-card.active{
      background: rgba(255,255,255,0.07);
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }

    .slots{ display:grid; gap: 6px; grid-template-columns: repeat(var(--count), var(--cup-sz)); }

    /* ===== å›å½’ï¼šé«˜çº§ç»ç’ƒæ¯ ===== */
    .cup{
      width: var(--cup-sz); 
      height: calc(var(--cup-sz) * 0.92);
      border-radius:999px;
      position:relative; overflow:hidden;
      
      /* ç»ç’ƒè´¨æ„Ÿ */
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.25);
      box-shadow:
        inset 0 10px 20px rgba(0,0,0,.3),
        inset 0 -10px 20px rgba(255,255,255,.05),
        0 8px 16px rgba(0,0,0,.25);
      backdrop-filter: blur(1px);
    }
    /* æ¯å£é«˜å…‰ */
    .cup::before{
      content:""; position:absolute; inset:6px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18); opacity:.8; pointer-events:none; z-index: 2;
    }
    /* æ¯èº«åå…‰ */
    .cup::after{
      content:""; position:absolute; left:10px; top:10px;
      width:30%; height:60%; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.25), transparent);
      opacity:.7; pointer-events:none; filter: blur(1px); z-index: 2;
    }
    .cup.dropHover{ outline: 2px solid var(--blue); outline-offset: 2px; }

    /* ===== å›å½’ï¼šæ³¼å¢¨æ®‹ç•™ (Residue) ===== */
    .cup .residue-layer {
      position: absolute; inset: 0;
      background: 
        radial-gradient(circle at 50% 70%, var(--c) 0%, transparent 60%),
        radial-gradient(circle at 30% 40%, var(--c) 0%, transparent 40%);
      opacity: 0.6;
      filter: blur(6px);
      z-index: 1;
      pointer-events: none;
      /* ç®€å•çš„è¿›åœºåŠ¨ç”» */
      animation: stain 0.5s ease-out forwards;
    }
    @keyframes stain { from { opacity: 0; transform: scale(0.8); } to { opacity: 0.6; transform: scale(1); } }

    /* ===== æ³¼å¢¨çˆ†å¼€æ•ˆæœ (Splat) ===== */
    .splat {
        position: absolute; inset: 10%;
        background: var(--c);
        mask-image: radial-gradient(circle, black 40%, transparent 70%);
        -webkit-mask-image: radial-gradient(circle, black 40%, transparent 70%);
        border-radius: 50%;
        opacity: 0;
        z-index: 5;
        animation: splatter 0.4s ease-out forwards;
        pointer-events: none;
    }
    @keyframes splatter {
        0% { transform: scale(0.2); opacity: 0.9; }
        50% { opacity: 0.8; }
        100% { transform: scale(1.5); opacity: 0; }
    }

    /* ===== å›å½’ï¼šé«˜çº§è½¯ç³– ===== */
    .candy{
      width: var(--candy-w); height: var(--candy-h);
      border-radius:999px;
      position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);
      z-index: 10;
      
      border:1px solid rgba(255,255,255,.25);
      box-shadow:
        inset 0 6px 10px rgba(255,255,255,.25),
        inset 0 -10px 14px rgba(0,0,0,.25),
        0 6px 12px rgba(0,0,0,.3);
      background: linear-gradient(135deg, var(--bg), rgba(0,0,0,0.1));
    }
    .candy::before{
      content:""; position:absolute; left:15%; top:15%;
      width:50%; height:50%; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), transparent 70%);
      transform: rotate(-15deg); pointer-events:none;
    }
    
    .candy.pop-anim { animation: pop-candy 0.3s ease-in forwards; }
    @keyframes pop-candy { to { transform: translate(-50%, 10px) scale(0.1); opacity: 0; } }

    /* åº•éƒ¨è°ƒè‰²ç›˜ */
    .palette-area {
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(15px);
      border-top: 1px solid rgba(255,255,255,0.15);
      padding: 10px 0 25px 0;
    }
    .palette-scroll {
      display:flex; gap:10px; padding:0 16px; overflow-x:auto; align-items:center; height: 60px;
    }
    .p-item { width: 50px; height: 50px; flex-shrink: 0; position: relative; display: flex; justify-content: center; align-items: center; }
    .palette-candy { position: relative; left: auto; top: auto; transform: none; width: 100%; height: 100%; }
    .candy.used { opacity: 0.4; filter: grayscale(0.6) brightness(0.8); }

    /* æ‹–æ‹½å¹»å½± */
    .drag-ghost {
      position: fixed; pointer-events: none; z-index: 9999;
      width: 54px; height: 40px; opacity: 0.9;
      transform: translate(-50%, -50%) scale(1.1);
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }

  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <div class="app-container">
    <header>
        <h1>ğŸ¬ æœæ±è½¯ç³–</h1>
        <div class="status-bar">
            <div>å…³å¡ <span id="level">1</span></div>
            <div>é…å¯¹ <span id="pairs">3</span></div>
        </div>
    </header>
    
    <div class="controls">
        <button class="btn" id="soundBtn">ğŸ”‡</button>
        <button class="btn" id="resetBtn">â†º é‡ç½®</button>
        <button class="btn" id="wipeBtn" style="color:#fca5a5; border-color:rgba(239,68,68,0.3)">âš  æ¸…æ¡£</button>
    </div>

    <div class="game-area">
        <div class="attempts-scroll" id="attempts"></div>
    </div>

    <div class="palette-area">
        <div class="palette-scroll" id="palette"></div>
    </div>
  </div>

  <audio id="bg-soda" loop src="soda.mp3"></audio>
  <audio id="sfx-pop" src="pop.mp3"></audio>
  <audio id="sfx-correct" src="rightanswer-95219.mp3"></audio>

<script>
(() => {
  /* --- é…ç½® --- */
  const COLORS = [
    "#ef4444", "#f97316", "#fde047", "#16a34a", "#22d3ee", "#1d4ed8", "#a855f7", 
    "#fb7185", "#5b341a", "#9ca3af", "#84cc16", "#4338ca", "#e11d48", "#14532d"
  ];
  const KEY_SAVE = 'gummy_v4_save';
  
  let state = {
    level: 1, pairCount: 3, colors: [], answer: [],
    rows: [], activeRow: 0, sound: false
  };

  /* --- æ¸¸æˆé€»è¾‘ --- */
  function initGame() {
    const savedLvl = localStorage.getItem(KEY_SAVE);
    state.level = savedLvl ? parseInt(savedLvl) : 1;
    startLevel();
  }

  function getPairCount(lvl) {
    if (lvl > 25) return Math.floor(Math.random() * 6) + 9;
    if (lvl === 1) return 3;
    const n = 4 + Math.floor((lvl - 2) / 3);
    return Math.min(n, 9);
  }

  function startLevel() {
    state.pairCount = getPairCount(state.level);
    const pool = COLORS.map((_, i) => i).sort(() => Math.random() - 0.5);
    state.colors = pool.slice(0, state.pairCount);
    state.answer = [...state.colors].sort(() => Math.random() - 0.5);
    
    state.rows = [{ 
        guess: Array(state.pairCount).fill(null), 
        status: 'active',
        residue: Array(state.pairCount).fill(null) // å›å½’ï¼šè®°å½•æ®‹ç•™é¢œè‰²
    }];
    state.activeRow = 0;

    renderUI();
    adjustSize();
  }

  function handleGuess(rowIdx, slotIdx, colorId) {
    const row = state.rows[rowIdx];
    if (row.status !== 'active') return;
    const existIdx = row.guess.indexOf(colorId);
    if (existIdx !== -1 && existIdx !== slotIdx) row.guess[existIdx] = null;
    row.guess[slotIdx] = colorId;
    renderBoard();
    if (row.guess.every(c => c !== null)) checkRow(row);
  }

  function checkRow(row) {
    const isCorrect = row.guess.every((c, i) => c === state.answer[i]);
    
    if (isCorrect) {
        row.status = 'win';
        playSound('correct');
        renderBoard();
        setTimeout(() => {
            state.level++; localStorage.setItem(KEY_SAVE, state.level);
            startLevel();
        }, 1000);
    } else {
        row.status = 'bad';
        playSound('pop');
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šè®¡ç®—æ®‹ç•™ (Residue)
        row.guess.forEach((cid, i) => {
            const isRight = (cid === state.answer[i]);
            // å¦‚æœé”™äº†ï¼Œå°±æŠŠè¿™ä¸ªé¢œè‰²ç•™åœ¨æ¯å­é‡Œ (residue)
            // å¦‚æœä¹‹å‰å·²ç»æœ‰æ®‹ç•™ï¼Œè¿™é‡Œä¿ç•™ä¹‹å‰çš„è¿˜æ˜¯æ–°çš„ï¼Ÿé€šå¸¸æ˜¯å åŠ æˆ–ä¿ç•™æœ€æ–°çš„
            if (!isRight) {
                row.residue[i] = COLORS[cid]; 
            }
        });

        renderBoard(); // è§¦å‘æ¸²æŸ“ï¼Œæ˜¾ç¤º residue å’Œ splat
        
        // å»¶æ—¶è¿›å…¥ä¸‹ä¸€è¡Œ
        setTimeout(() => {
            state.rows.push({ 
                guess: Array(state.pairCount).fill(null), 
                status: 'active',
                residue: Array(state.pairCount).fill(null)
            });
            state.activeRow++;
            renderBoard();
            const el = document.getElementById('attempts');
            el.scrollTop = el.scrollHeight;
        }, 600); // ç¨å¾®ç»™ç‚¹æ—¶é—´çœ‹çˆ†ç‚¸æ•ˆæœ
    }
  }

  /* --- æ¸²æŸ“ --- */
  function adjustSize() {
    const containerW = Math.min(window.innerWidth, 440); 
    const usableW = containerW - 24; 
    let sz = (usableW - (state.pairCount - 1) * 6) / state.pairCount;
    sz = Math.max(30, Math.min(65, sz));
    document.documentElement.style.setProperty('--cup-sz', sz + 'px');
    document.documentElement.style.setProperty('--count', state.pairCount);
    // åŠ¨æ€è°ƒæ•´ç³–æœå†…è¾¹è·
    if (sz < 40) {
        document.documentElement.style.setProperty('--candy-w', '90%');
        document.documentElement.style.setProperty('--candy-h', '80%');
    } else {
        document.documentElement.style.setProperty('--candy-w', '86%');
        document.documentElement.style.setProperty('--candy-h', '68%');
    }
  }

  function renderUI() {
    document.getElementById('level').innerText = state.level;
    document.getElementById('pairs').innerText = state.pairCount;
    renderPalette();
    renderBoard();
  }

  function renderPalette() {
    const p = document.getElementById('palette');
    p.innerHTML = '';
    const activeRow = state.rows[state.activeRow];
    const used = new Set(activeRow ? activeRow.guess : []);

    state.colors.forEach(cid => {
        const wrap = document.createElement('div');
        wrap.className = 'p-item';
        const c = document.createElement('div');
        c.className = 'candy palette-candy';
        c.style.setProperty('--bg', COLORS[cid]);
        if (used.has(cid)) c.classList.add('used');
        
        c.addEventListener('touchstart', (e) => handleTouchStart(e, c, cid), {passive: false});
        c.onmousedown = (e) => {
            handleTouchStart({
                preventDefault:()=>{}, 
                changedTouches:[{identifier:99, clientX:e.clientX, clientY:e.clientY}],
                touches: []
            }, c, cid);
        };
        wrap.appendChild(c);
        p.appendChild(wrap);
    });
  }

  function renderBoard() {
    const board = document.getElementById('attempts');
    board.innerHTML = '';

    state.rows.forEach((row, rIdx) => {
        const card = document.createElement('div');
        card.className = 'row-card' + (rIdx === state.activeRow ? ' active' : '');
        const slots = document.createElement('div');
        slots.className = 'slots';
        
        // éå†æ¯ä¸€æ ¼
        for(let sIdx=0; sIdx<state.pairCount; sIdx++) {
            const cid = row.guess[sIdx];
            const cup = document.createElement('div');
            cup.className = 'cup';
            cup.dataset.r = rIdx; cup.dataset.s = sIdx;

            // 1. æ¸²æŸ“æ®‹ç•™ (Residue) - æ°¸è¿œåœ¨åº•å±‚
            if (row.residue[sIdx]) {
                const resLayer = document.createElement('div');
                resLayer.className = 'residue-layer';
                resLayer.style.setProperty('--c', row.residue[sIdx]);
                cup.appendChild(resLayer);
            }

            // 2. æ¸²æŸ“é”™è¯¯çˆ†ç‚¸ (Splat) - åªåœ¨åˆšå‡ºé”™çš„é‚£ä¸€ç¬é—´æ˜¾ç¤º
            if (row.status === 'bad' && cid !== null && cid !== state.answer[sIdx]) {
                const splat = document.createElement('div');
                splat.className = 'splat';
                splat.style.setProperty('--c', COLORS[cid]);
                cup.appendChild(splat);
            }

            // 3. æ¸²æŸ“ç³–æœæœ¬ä½“
            // é€»è¾‘ï¼šå¦‚æœè¿™ä¸€è¡Œæ˜¯ badï¼Œä¸”è¿™ä¸ªç³–æœæ˜¯é”™çš„ï¼Œå®ƒåº”è¯¥æ¶ˆå¤±ï¼ˆpopæ‰ï¼‰æˆ–è€…è¢«çˆ†ç‚¸æ©ç›–
            // ä½†ä¸ºäº†è§†è§‰è¿è´¯ï¼Œæˆ‘ä»¬è®©å®ƒæ’­æ”¾ä¸€ä¸ªæ¶ˆå¤±åŠ¨ç”»
            if (cid !== null) {
                // å¦‚æœæ˜¯åçš„è¡Œï¼Œä¸”æ˜¯é”™çš„ç³–æœ -> æ’­æ”¾æ¶ˆå¤±åŠ¨ç”»
                if (row.status === 'bad' && cid !== state.answer[sIdx]) {
                    const c = document.createElement('div');
                    c.className = 'candy pop-anim'; // å¢åŠ æ¶ˆå¤±åŠ¨ç”»
                    c.style.setProperty('--bg', COLORS[cid]);
                    cup.appendChild(c);
                } 
                // å¦åˆ™ï¼ˆæ­£å¸¸çŒœæµ‹ä¸­ï¼Œæˆ–è€…çŒœå¯¹äº†ï¼‰ï¼Œæ­£å¸¸æ˜¾ç¤ºç³–æœ
                else {
                    const c = document.createElement('div');
                    c.className = 'candy';
                    c.style.setProperty('--bg', COLORS[cid]);
                    cup.appendChild(c);
                }
            }
            slots.appendChild(cup);
        }
        card.appendChild(slots);
        board.appendChild(card);
    });
  }

  /* --- äº¤äº’ (æ‹–æ‹½) --- */
  let ghost = null, dragId = null, activeColor = null, hoverCup = null;

  function handleTouchStart(e, el, cid) {
    e.preventDefault();
    const t = e.changedTouches[0] || e; 
    dragId = t.identifier; activeColor = cid;
    
    ghost = el.cloneNode(true);
    ghost.className = 'candy drag-ghost';
    ghost.style.setProperty('--bg', COLORS[cid]);
    ghost.style.left = t.clientX + 'px';
    ghost.style.top = t.clientY + 'px';
    document.body.appendChild(ghost);
  }

  document.addEventListener('touchmove', (e) => {
    if (!ghost) return;
    const t = Array.from(e.changedTouches).find(x => x.identifier === dragId);
    if (!t) return;
    e.preventDefault();
    ghost.style.left = t.clientX + 'px'; ghost.style.top = t.clientY + 'px';
    
    const elUnder = document.elementFromPoint(t.clientX, t.clientY);
    const cup = elUnder ? elUnder.closest('.cup') : null;
    if (cup && parseInt(cup.dataset.r) === state.activeRow) {
        if (hoverCup !== cup) {
            if (hoverCup) hoverCup.classList.remove('dropHover');
            cup.classList.add('dropHover'); hoverCup = cup;
        }
    } else if (hoverCup) {
        hoverCup.classList.remove('dropHover'); hoverCup = null;
    }
  }, {passive: false});
  
  // é¼ æ ‡å…¼å®¹
  document.addEventListener('mousemove', (e) => {
      if (dragId === 99) { 
         ghost.style.left = e.clientX + 'px'; ghost.style.top = e.clientY + 'px';
         const elUnder = document.elementFromPoint(e.clientX, e.clientY);
         const cup = elUnder ? elUnder.closest('.cup') : null;
         if (cup && parseInt(cup.dataset.r) === state.activeRow) {
            if (hoverCup !== cup) {
                if(hoverCup) hoverCup.classList.remove('dropHover');
                cup.classList.add('dropHover'); hoverCup = cup;
            }
         } else if(hoverCup) { hoverCup.classList.remove('dropHover'); hoverCup = null; }
      }
  });

  const endDrag = (e) => {
    if (!ghost) return;
    ghost.remove(); ghost = null; dragId = null;
    if (hoverCup) {
        hoverCup.classList.remove('dropHover');
        handleGuess(parseInt(hoverCup.dataset.r), parseInt(hoverCup.dataset.s), activeColor);
        hoverCup = null;
    }
  };
  document.addEventListener('touchend', endDrag);
  document.addEventListener('mouseup', endDrag);

  /* --- èƒŒæ™¯æ³¡æ³¡ --- */
  const bg = document.getElementById("bgBubbles");
  for(let i=0;i<20;i++){
    const b = document.createElement("div");
    b.className = "bubble";
    const size = 15 + Math.random()*35;
    b.style.setProperty("--size", size+"px");
    b.style.setProperty("--x", Math.random()*100 + "vw");
    b.style.setProperty("--dur", (12+Math.random()*15)+"s");
    b.style.setProperty("--delay", (-Math.random()*20)+"s");
    b.style.setProperty("--sway", (3+Math.random()*4)+"s");
    b.style.setProperty("--sx", (Math.random()*30-15)+"px");
    bg.appendChild(b);
  }

  /* --- éŸ³é¢‘/æŒ‰é’® --- */
  const audios = { bg: document.getElementById('bg-soda'), pop: document.getElementById('sfx-pop'), correct: document.getElementById('sfx-correct') };
  audios.bg.volume = 0.3;
  function playSound(key) {
    if (!state.sound) return;
    audios[key].currentTime = 0;
    audios[key].play().catch(()=>{});
  }
  document.getElementById('soundBtn').onclick = function() {
    state.sound = !state.sound; this.innerText = state.sound ? 'ğŸ”Š' : 'ğŸ”‡';
    state.sound ? audios.bg.play().catch(()=>{}) : audios.bg.pause();
  };
  document.getElementById('resetBtn').onclick = () => startLevel();
  document.getElementById('wipeBtn').onclick = () => { if(confirm('ç¡®å®šæ¸…æ¡£ï¼Ÿ')) { localStorage.removeItem(KEY_SAVE); state.level = 1; startLevel(); }};
  window.addEventListener('resize', adjustSize);
  initGame();
  if ("serviceWorker" in navigator) { window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{})); }
})();
</script>
</body>
</html>
