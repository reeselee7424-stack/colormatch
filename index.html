<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æœæ±è½¯ç³– - æœå†»è´¨æ„Ÿç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --text: #e2e8f0;
      --cup-sz: 58px; 
      --candy-sz: 48px; 
    }

    body{
      margin:0; height:100vh; display:flex; justify-content:center;
      font-family: system-ui,-apple-system,sans-serif;
      color:var(--text); overflow:hidden; overscroll-behavior: none;
      
      /* æ·±è“èƒŒæ™¯ */
      background: radial-gradient(circle at 50% 120%, #1e293b 0%, #0f172a 40%, #020617 100%);
    }

    .bg-bubbles{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .bubble{
      position:absolute; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03), transparent 70%);
      bottom:-50px; left: var(--x); width: var(--size); height: var(--size);
      animation: float 20s infinite ease-in-out; 
      animation-delay: var(--delay);
    }
    @keyframes float { 
        0%, 100% { transform: translate(0, 0); opacity: 0.3; }
        50% { transform: translate(20px, -40px); opacity: 0.6; }
    }

    .app-container {
      width: 100%; max-width: 440px; height: 100%;
      position: relative; display: flex; flex-direction: column; z-index: 1;
      background: rgba(0,0,0,0.2);
    }

    header{
      padding: 12px 20px; display:flex; justify-content:space-between; align-items:center;
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.8), transparent);
    }
    h1{ margin:0; font-size:16px; font-weight: 600; letter-spacing: 1px; color: #fff; }
    
    .status-bar{ font-size:13px; color: #94a3b8; display:flex; gap:12px; }
    .status-bar span { color:#fff; font-weight: bold; }

    .controls { display: flex; gap: 10px; padding: 0 16px; justify-content: flex-end; }
    .btn{
      background:rgba(255, 255, 255, 0.08); color:#cbd5e1; 
      border:1px solid rgba(255,255,255,0.1);
      padding:6px 14px; border-radius:20px; font-size: 12px; cursor: pointer;
      backdrop-filter: blur(4px);
    }

    .game-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 20px 10px; }
    .attempts-scroll {
        flex: 1; overflow-y: auto; padding: 10px 0;
        display: flex; flex-direction: column; gap: 14px;
        scroll-behavior: smooth;
    }
    .attempts-scroll::-webkit-scrollbar { display: none; }

    .row-card{
      display: flex; justify-content: center; padding: 6px;
      border-radius: 99px;
      flex-shrink: 0;
      transition: all 0.3s;
    }
    .row-card.active{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 0 30px rgba(0,0,0,0.2);
    }

    .slots{ display:grid; gap: 10px; grid-template-columns: repeat(var(--count), var(--cup-sz)); justify-content: center;}

    /* æ¯å­ */
    .cup{
      width: var(--cup-sz); height: var(--cup-sz);
      border-radius: 50%; position:relative; 
      border: 1px solid rgba(255,255,255,0.15);
      background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%);
      box-shadow: inset 0 2px 4px rgba(255,255,255,0.05), inset 0 -2px 6px rgba(0,0,0,0.3);
    }
    .cup.dropHover{ border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.1); }

    .residue-layer {
      position: absolute; inset: 2px; border-radius: 50%;
      background: var(--c); opacity: 0.6; 
      mask-image: radial-gradient(circle, black 40%, transparent 80%);
      -webkit-mask-image: radial-gradient(circle, black 40%, transparent 80%);
      pointer-events: none;
    }

    /* ===== æ ¸å¿ƒä¿®æ”¹ï¼šæœå†»è½¯ç³–è´¨æ„Ÿ (å‚è€ƒå›¾) ===== */
    .candy{
      width: var(--candy-sz); height: calc(var(--candy-sz) * 0.92);
      /* å½¢çŠ¶ï¼šæ–¹åœ†/é¦’å¤´å½¢ */
      border-radius: 35% 35% 45% 45%; 
      position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); 
      z-index: 10;
      
      /* 1. åŸºç¡€è‰² + å†…éƒ¨é€å…‰ */
      background: radial-gradient(130% 130% at 30% 20%, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.1) 20%, var(--bg) 60%, rgba(0,0,0,0.3) 100%);
      
      /* 2. è¾¹ç¼˜åšåº¦æ„Ÿ */
      box-shadow: 
        inset 0 -4px 6px rgba(0,0,0,0.2), /* åº•éƒ¨åšåº¦ */
        0 4px 8px rgba(0,0,0,0.3); /* æŠ•å½± */
        
      transition: opacity 0.1s, transform 0.1s;
    }
    
    /* 3. å¼ºçƒˆçš„é«˜å…‰ (æ¹¿æ¶¦æ„Ÿ) */
    .candy::after{
      content:""; position:absolute; left: 15%; top: 15%; width: 35%; height: 25%;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.2));
      filter: blur(1px);
    }
    /* 4. äºŒæ¬¡é«˜å…‰ */
    .candy::before{
      content:""; position:absolute; right: 20%; bottom: 20%; width: 15%; height: 15%;
      border-radius: 50%;
      background: rgba(255,255,255,0.4);
      filter: blur(2px);
    }
    
    /* ä¸ƒå½©ç³–æœ */
    .candy[data-rainbow="true"] {
        background: conic-gradient(from 180deg, red, orange, yellow, green, cyan, blue, violet, red);
        box-shadow: inset 0 0 10px rgba(255,255,255,0.5), 0 4px 8px rgba(0,0,0,0.3);
    }

    .candy.fade-out { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }

    /* ===== åº•éƒ¨è°ƒè‰²ç›˜ä¸â€œé˜´å½±å‘â€ ===== */
    .palette-area {
        background: linear-gradient(to bottom, #1e3a8a, #0f172a);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 0 30px 0;
        position: relative;
    }
    
    .palette-scroll { 
        display:flex; gap:12px; padding:0 20px; overflow-x:auto; height: 70px; align-items:center; 
        justify-content: center; 
    }
    
    /* å¤–å±‚å®¹å™¨ï¼šè´Ÿè´£æ˜¾ç¤ºâ€œé˜´å½±/å‡¹æ§½â€ */
    .p-item { 
        width: 56px; height: 56px; flex-shrink: 0; 
        display:flex; justify-content:center; align-items:center; 
        position: relative;
        
        /* æ ¸å¿ƒï¼šè¿™é‡Œæ¨¡æ‹Ÿâ€œç©ºæ§½â€çš„åŠé€æ˜é˜´å½± */
        border-radius: 35% 35% 45% 45%; /* å½¢çŠ¶å’Œç³–æœä¸€è‡´ */
        background: rgba(0,0,0,0.25); /* åŠé€æ˜é»‘ */
        box-shadow: inset 0 2px 6px rgba(0,0,0,0.4); /* å†…é™·æ„Ÿ */
    }

    .palette-candy { 
        position: relative; 
        /* ç›–ä½åº•ä¸‹çš„é˜´å½± */
        transform: scale(1); 
    }
    
    /* æ‹–æ‹½æ—¶ï¼šéšè—æºç³–æœ -> éœ²å‡ºåº•ä¸‹çš„ .p-item èƒŒæ™¯ */
    .palette-candy.is-dragging { opacity: 0; }
    
    .candy.used { filter: grayscale(1) opacity(0.3); }

    .drag-ghost {
      position: fixed; pointer-events: none; z-index: 9999;
      width: 50px; height: 46px; opacity: 1;
      transform: translate(-50%, -50%) scale(1.15);
      filter: drop-shadow(0 15px 15px rgba(0,0,0,0.4));
    }
  </style>
</head>

<body>
  <div class="bg-bubbles" id="bgBubbles"></div>

  <audio id="bg-soda" loop src="soda.mp3" preload="auto"></audio>
  <audio id="sfx-pop" src="pop.mp3" preload="auto"></audio>
  <audio id="sfx-correct" src="correct.mp3" preload="auto"></audio>

  <div class="app-container">
    <header>
        <h1>æœæ±è½¯ç³–é…å¯¹</h1>
        <div class="status-bar">
            <span>ç¬¬ <span id="level">1</span> å…³</span>
        </div>
        <div class="controls">
            <button class="btn" id="soundBtn">ğŸ”‡</button>
            <button class="btn" id="resetBtn">é‡ç½®</button>
            <button class="btn" id="wipeBtn" style="color:#fca5a5; border-color:rgba(239,68,68,0.4)">æ¸…æ¡£</button>
        </div>
    </header>

    <div class="game-area">
        <div class="attempts-scroll" id="attempts"></div>
    </div>

    <div class="palette-area">
        <div class="palette-scroll" id="palette"></div>
    </div>
  </div>

<script>
(() => {
  /* é¢œè‰²æ±  (15è‰²) */
  const COLORS = [
    { hex: "#ff2e2e" }, { hex: "#ff9f0a" }, { hex: "#ffd60a" }, { hex: "#30d158" },
    { hex: "#22d3ee" }, { hex: "#0a84ff" }, { hex: "#bf5af2" }, { hex: "#ff375f" },
    { hex: "#8d6e63" }, { hex: "#2d3436" }, { hex: "#f1f5f9" }, { hex: "#94a3b8" },
    { hex: "#0abab5" }, { hex: "#008080" }, { hex: "rainbow" }
  ];
  const KEY_SAVE = 'gummy_v14_save';
  
  let state = { level: 1, pairCount: 3, colors: [], answer: [], rows: [], activeRow: 0, sound: true };
  
  const audios = { 
    bg: document.getElementById('bg-soda'), 
    pop: document.getElementById('sfx-pop'), 
    correct: document.getElementById('sfx-correct') 
  };

  // å¼ºåŠ›è§£é”ï¼šä»»æ„äº¤äº’æ¿€æ´»éŸ³é¢‘
  function unlockAudio() {
    Object.values(audios).forEach(a => {
        a.volume = 0; 
        a.play().then(() => {
            setTimeout(() => { 
                a.pause(); a.currentTime=0; 
                if(a.id==='bg-soda') a.volume=0.3; else a.volume=1; 
            }, 10);
        }).catch(()=>{});
    });
    document.removeEventListener('touchstart', unlockAudio);
    document.removeEventListener('click', unlockAudio);
    if(state.sound) setTimeout(() => audios.bg.play().catch(()=>{}), 500);
  }
  document.addEventListener('touchstart', unlockAudio, {once:true});
  document.addEventListener('click', unlockAudio, {once:true});

  function playSound(key) {
    if (!state.sound) return;
    const a = audios[key];
    if (a) { a.currentTime=0; a.volume=1; a.play().catch(e => {}); }
  }

  /* --- æ¸¸æˆé€»è¾‘ --- */
  function initGame() {
    const savedLvl = localStorage.getItem(KEY_SAVE);
    state.level = savedLvl ? parseInt(savedLvl) : 1;
    startLevel();
  }
  function getPairCount(lvl) {
    if (lvl > 25) return Math.floor(Math.random() * 6) + 9;
    if (lvl === 1) return 3;
    return Math.min(4 + Math.floor((lvl - 2) / 3), 9);
  }
  function startLevel() {
    state.pairCount = getPairCount(state.level);
    const poolIndices = COLORS.map((_, i) => i).sort(() => Math.random() - 0.5);
    state.colors = poolIndices.slice(0, state.pairCount);
    state.answer = [...state.colors].sort(() => Math.random() - 0.5);
    state.rows = [{ guess: Array(state.pairCount).fill(null), status: 'active', residue: [] }];
    state.activeRow = 0;
    renderUI(); adjustSize();
  }

  function handleGuess(rowIdx, slotIdx, colorIdx) {
    const row = state.rows[rowIdx];
    if (row.status !== 'active') return;
    const existIdx = row.guess.indexOf(colorIdx);
    if (existIdx !== -1 && existIdx !== slotIdx) row.guess[existIdx] = null;
    row.guess[slotIdx] = colorIdx;
    renderBoard();
    if (row.guess.every(c => c !== null)) checkRow(row);
  }

  function checkRow(row) {
    const isCorrect = row.guess.every((c, i) => c === state.answer[i]);
    if (isCorrect) {
        row.status = 'win'; playSound('correct'); renderBoard();
        setTimeout(() => { state.level++; localStorage.setItem(KEY_SAVE, state.level); startLevel(); }, 1200);
    } else {
        row.status = 'bad'; playSound('pop');
        row.guess.forEach((cIdx, i) => { if (cIdx !== state.answer[i]) row.residue[i] = COLORS[cIdx].hex; });
        renderBoard();
        setTimeout(() => {
            state.rows.push({ guess: Array(state.pairCount).fill(null), status: 'active', residue: [] });
            state.activeRow++; renderBoard();
            const el = document.getElementById('attempts'); el.scrollTop = el.scrollHeight;
        }, 600);
    }
  }

  /* --- æ¸²æŸ“ --- */
  function adjustSize() {
    const w = Math.min(window.innerWidth, 440) - 20; 
    let sz = (w - (state.pairCount - 1) * 8) / state.pairCount;
    sz = Math.max(34, Math.min(68, sz));
    document.documentElement.style.setProperty('--cup-sz', sz + 'px');
    document.documentElement.style.setProperty('--candy-sz', (sz * 0.82) + 'px');
    document.documentElement.style.setProperty('--count', state.pairCount);
  }

  function renderUI() {
    document.getElementById('level').innerText = state.level;
    renderPalette(); renderBoard();
  }

  function renderPalette() {
    const p = document.getElementById('palette'); p.innerHTML = '';
    const activeRow = state.rows[state.activeRow];
    const used = new Set(activeRow ? activeRow.guess : []);
    
    state.colors.forEach(cIdx => {
        const wrap = document.createElement('div'); wrap.className = 'p-item';
        
        const c = createCandy(cIdx);
        c.className += ' palette-candy';
        
        if (used.has(cIdx)) c.classList.add('used');
        c.dataset.cid = cIdx;
        
        c.addEventListener('touchstart', (e) => handleTouchStart(e, c, cIdx), {passive: false});
        wrap.appendChild(c);
        p.appendChild(wrap);
    });
  }

  function createCandy(colorIdx) {
      const d = document.createElement('div');
      d.className = 'candy';
      const colorData = COLORS[colorIdx];
      if (colorData.hex === 'rainbow') d.dataset.rainbow = "true";
      else d.style.setProperty('--bg', colorData.hex);
      return d;
  }

  function renderBoard() {
    const board = document.getElementById('attempts'); board.innerHTML = '';
    state.rows.forEach((row, rIdx) => {
        const card = document.createElement('div');
        card.className = 'row-card' + (rIdx === state.activeRow ? ' active' : '');
        const slots = document.createElement('div'); slots.className = 'slots';
        
        for(let sIdx=0; sIdx<state.pairCount; sIdx++) {
            const cIdx = row.guess[sIdx];
            const cup = document.createElement('div');
            cup.className = 'cup'; cup.dataset.r = rIdx; cup.dataset.s = sIdx;
            
            if (row.residue[sIdx]) {
                const res = document.createElement('div'); res.className = 'residue-layer';
                const resColor = row.residue[sIdx] === 'rainbow' ? '#a55eea' : row.residue[sIdx];
                res.style.setProperty('--c', resColor); cup.appendChild(res);
            }
            if (cIdx !== null) {
                const c = createCandy(cIdx);
                if (row.status === 'bad' && cIdx !== state.answer[sIdx]) c.classList.add('fade-out');
                cup.appendChild(c);
            }
            slots.appendChild(cup);
        }
        card.appendChild(slots); board.appendChild(card);
    });
  }

  /* --- äº¤äº’ --- */
  let ghost = null, dragId = null, activeColor = null, hoverCup = null, sourceEl = null;

  function cleanupGhost() {
    if (ghost) ghost.remove();
    if (sourceEl) sourceEl.classList.remove('is-dragging');
    if (hoverCup) hoverCup.classList.remove('dropHover');
    ghost = null; dragId = null; sourceEl = null; hoverCup = null;
  }

  function handleTouchStart(e, el, cIdx) {
    if(el.classList.contains('used')) return;
    e.preventDefault();
    const t = e.changedTouches[0]; 
    dragId = t.identifier; activeColor = cIdx; sourceEl = el;
    
    sourceEl.classList.add('is-dragging');

    ghost = el.cloneNode(true);
    ghost.className = 'candy drag-ghost';
    ghost.classList.remove('is-dragging', 'palette-candy');
    
    const colorData = COLORS[cIdx];
    if(colorData.hex !== 'rainbow') ghost.style.setProperty('--bg', colorData.hex);

    ghost.style.left = t.clientX + 'px'; ghost.style.top = t.clientY + 'px';
    document.body.appendChild(ghost);
  }

  document.addEventListener('touchmove', (e) => {
    if (!ghost) return;
    const t = Array.from(e.changedTouches).find(x => x.identifier === dragId);
    if (!t) return;
    e.preventDefault();
    ghost.style.left = t.clientX + 'px'; ghost.style.top = t.clientY + 'px';
    
    const elUnder = document.elementFromPoint(t.clientX, t.clientY);
    const cup = elUnder ? elUnder.closest('.cup') : null;
    if (cup && parseInt(cup.dataset.r) === state.activeRow) {
        if (hoverCup !== cup) {
            if (hoverCup) hoverCup.classList.remove('dropHover');
            cup.classList.add('dropHover'); hoverCup = cup;
        }
    } else if (hoverCup) { hoverCup.classList.remove('dropHover'); hoverCup = null; }
  }, {passive: false});

  const endDrag = (e) => {
    if (!ghost) return;
    if (hoverCup) {
        handleGuess(parseInt(hoverCup.dataset.r), parseInt(hoverCup.dataset.s), activeColor);
    }
    cleanupGhost();
  };
  
  document.addEventListener('touchend', endDrag);
  document.addEventListener('touchcancel', cleanupGhost);

  const bg = document.getElementById("bgBubbles");
  for(let i=0;i<20;i++){ 
    const b = document.createElement("div"); b.className = "bubble";
    const size = 10 + Math.random()*25;
    b.style.setProperty("--size", size+"px"); b.style.setProperty("--x", Math.random()*100 + "vw");
    b.style.setProperty("--dur", (10+Math.random()*20)+"s");
    b.style.setProperty("--delay", (-Math.random()*20)+"s");
    bg.appendChild(b);
  }

  document.getElementById('soundBtn').onclick = function() {
    state.sound = !state.sound; this.innerText = state.sound ? 'ğŸ”Š' : 'ğŸ”‡';
    state.sound ? audios.bg.play().catch(()=>{}) : audios.bg.pause();
  };
  document.getElementById('resetBtn').onclick = () => startLevel();
  document.getElementById('wipeBtn').onclick = () => { if(confirm('ç¡®å®šæ¸…æ¡£ï¼Ÿ')) { localStorage.removeItem(KEY_SAVE); state.level = 1; startLevel(); }};
  window.addEventListener('resize', adjustSize);
  initGame();
  if ("serviceWorker" in navigator) window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
})();
</script>
</body>
</html>
